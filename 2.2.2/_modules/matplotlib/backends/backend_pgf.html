<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>matplotlib.backends.backend_pgf — Matplotlib 2.2.2 documentation</title>
<link href="../../../_static/mpl.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/gallery.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
<script src="../../../_static/jquery.js" type="text/javascript"></script>
<script src="../../../_static/underscore.js" type="text/javascript"></script>
<script src="../../../_static/doctools.js" type="text/javascript"></script>
<link href="../../../_static/opensearch.xml" rel="search" title="Search within Matplotlib 2.2.2 documentation" type="application/opensearchdescription+xml"/>
<link href="../../../_static/favicon.ico" rel="shortcut icon"/>
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
<link href="../../../index.html" rel="top" title="Matplotlib 2.2.2 documentation"/>
<link href="../../matplotlib.html" rel="up" title="matplotlib"/>
<link href="https://matplotlib.org/_modules/matplotlib/backends/backend_pgf.html" rel="canonical"/>
<link href="https://matplotlib.org/_modules/matplotlib/backends/backend_pgf.html" rel="canonical"/></head>
<body><div id="old-version-banner">
            You are reading documentation for a static version of Matplotlib.
            <a href="https://matplotlib.org/_modules/matplotlib/backends/backend_pgf.html">This page may have been updated.</a>
</div>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px; position: relative;">
<a href="../../../index.html">
<div style="float: left; position: absolute; width: 496px; bottom: 0; padding-bottom: 24px"><span style="float: right; color: #789; background: white">Version 2.2.2</span></div>
<img alt="matplotlib" border="0" height="125px" src="../../../_static/logo2.png"/></a>
<!-- The "Fork me on github" ribbon -->
<div id="forkongithub"><a href="https://github.com/matplotlib/matplotlib">Fork me on GitHub</a></div>
</div>
<div class="related">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li><a href="../../../index.html">home</a>| </li>
<li><a href="../../../gallery/index.html">examples</a>| </li>
<li><a href="../../../tutorials/index.html">tutorials</a>| </li>
<li><a href="../../../api/pyplot_summary.html">pyplot</a>| </li>
<li><a href="../../../contents.html">docs</a> »</li>
<li><a href="../../index.html">Module code</a> »</li>
<li><a accesskey="U" href="../../matplotlib.html">matplotlib</a> »</li>
</ul>
</div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div id="searchbox" role="search" style="display: none">
<h3>Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input name="q" type="text"/>
<input type="submit" value="Go"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../contents.html">Documentation overview</a><ul>
<li><a href="../../index.html">Module code</a><ul>
<li><a href="../../matplotlib.html">matplotlib</a><ul>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body">
<h1>Source code for matplotlib.backends.backend_pgf</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">_png</span><span class="p">,</span> <span class="n">rcParams</span>
<span class="kn">from</span> <span class="nn">matplotlib.backend_bases</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">_Backend</span><span class="p">,</span> <span class="n">FigureCanvasBase</span><span class="p">,</span> <span class="n">FigureManagerBase</span><span class="p">,</span> <span class="n">GraphicsContextBase</span><span class="p">,</span>
    <span class="n">RendererBase</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_mixed</span> <span class="k">import</span> <span class="n">MixedModeRenderer</span>
<span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="k">import</span> <span class="n">is_writable_file_like</span>
<span class="kn">from</span> <span class="nn">matplotlib.compat</span> <span class="k">import</span> <span class="n">subprocess</span>
<span class="kn">from</span> <span class="nn">matplotlib.compat.subprocess</span> <span class="k">import</span> <span class="n">check_output</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="k">import</span> <span class="n">Path</span>


<span class="c1">###############################################################################</span>

<span class="c1"># create a list of system fonts, all of these should work with xe/lua-latex</span>
<span class="n">system_fonts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'win'</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">font_manager</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">font_manager</span><span class="o">.</span><span class="n">win32InstalledFonts</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">system_fonts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">font_manager</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">.</span><span class="n">family_name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># unknown error, skip this font</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># assuming fontconfig is installed and the command 'fc-list' exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># list scalable (non-bitmap) fonts</span>
        <span class="n">fc_list</span> <span class="o">=</span> <span class="n">check_output</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="s1">'fc-list'</span><span class="p">),</span> <span class="s1">':outline,scalable'</span><span class="p">,</span> <span class="s1">'family'</span><span class="p">])</span>
        <span class="n">fc_list</span> <span class="o">=</span> <span class="n">fc_list</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">)</span>
        <span class="n">system_fonts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fc_list</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
        <span class="n">system_fonts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">system_fonts</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">'error getting fonts from fc-list'</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

<div class="viewcode-block" id="get_texcommand"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.get_texcommand">[docs]</a><span class="k">def</span> <span class="nf">get_texcommand</span><span class="p">():</span>
    <span class="sd">"""Get chosen TeX system from rc."""</span>
    <span class="n">texsystem_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"xelatex"</span><span class="p">,</span> <span class="s2">"lualatex"</span><span class="p">,</span> <span class="s2">"pdflatex"</span><span class="p">]</span>
    <span class="n">texsystem</span> <span class="o">=</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.texsystem"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">texsystem</span> <span class="k">if</span> <span class="n">texsystem</span> <span class="ow">in</span> <span class="n">texsystem_options</span> <span class="k">else</span> <span class="s2">"xelatex"</span></div>


<div class="viewcode-block" id="get_fontspec"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.get_fontspec">[docs]</a><span class="k">def</span> <span class="nf">get_fontspec</span><span class="p">():</span>
    <span class="sd">"""Build fontspec preamble from rc."""</span>
    <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">texcommand</span> <span class="o">=</span> <span class="n">get_texcommand</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">texcommand</span> <span class="o">!=</span> <span class="s2">"pdflatex"</span><span class="p">:</span>
        <span class="n">latex_fontspec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{fontspec}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">texcommand</span> <span class="o">!=</span> <span class="s2">"pdflatex"</span> <span class="ow">and</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.rcfonts"</span><span class="p">]:</span>
        <span class="c1"># try to find fonts from rc parameters</span>
        <span class="n">families</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"serif"</span><span class="p">,</span> <span class="s2">"sans-serif"</span><span class="p">,</span> <span class="s2">"monospace"</span><span class="p">]</span>
        <span class="n">fontspecs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">"\setmainfont{</span><span class="si">%s</span><span class="s2">}"</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\setsansfont{</span><span class="si">%s</span><span class="s2">}"</span><span class="p">,</span>
                     <span class="sa">r</span><span class="s2">"\setmonofont{</span><span class="si">%s</span><span class="s2">}"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">family</span><span class="p">,</span> <span class="n">fontspec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">families</span><span class="p">,</span> <span class="n">fontspecs</span><span class="p">):</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"font."</span> <span class="o">+</span> <span class="n">family</span><span class="p">]</span>
                       <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">system_fonts</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">latex_fontspec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fontspec</span> <span class="o">%</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># no fonts found, fallback to LaTeX defaule</span>

    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">latex_fontspec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_preamble"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.get_preamble">[docs]</a><span class="k">def</span> <span class="nf">get_preamble</span><span class="p">():</span>
    <span class="sd">"""Get LaTeX preamble from rc."""</span>
    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.preamble"</span><span class="p">])</span></div>

<span class="c1">###############################################################################</span>

<span class="c1"># This almost made me cry!!!</span>
<span class="c1"># In the end, it's better to use only one unit for all coordinates, since the</span>
<span class="c1"># arithmetic in latex seems to produce inaccurate conversions.</span>
<span class="n">latex_pt_to_in</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">72.27</span>
<span class="n">latex_in_to_pt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">latex_pt_to_in</span>
<span class="n">mpl_pt_to_in</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">72.</span>
<span class="n">mpl_in_to_pt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">mpl_pt_to_in</span>

<span class="c1">###############################################################################</span>
<span class="c1"># helper functions</span>

<span class="n">NO_ESCAPE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?&lt;!</span><span class="se">\\</span><span class="s2">)(?:</span><span class="se">\\\\</span><span class="s2">)*"</span>
<span class="n">re_mathsep</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">"\$"</span><span class="p">)</span>
<span class="n">re_escapetext</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="s2">"([_^$%])"</span><span class="p">)</span>
<span class="n">repl_escapetext</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">re_mathdefault</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">"(</span><span class="se">\\</span><span class="s2">mathdefault)"</span><span class="p">)</span>
<span class="n">repl_mathdefault</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>


<div class="viewcode-block" id="common_texification"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.common_texification">[docs]</a><span class="k">def</span> <span class="nf">common_texification</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Do some necessary and/or useful substitutions for texts to be included in</span>
<span class="sd">    LaTeX documents.</span>
<span class="sd">    """</span>

    <span class="c1"># Sometimes, matplotlib adds the unknown command \mathdefault.</span>
    <span class="c1"># Not using \mathnormal instead since this looks odd for the latex cm font.</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re_mathdefault</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl_mathdefault</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="c1"># split text into normaltext and inline math parts</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re_mathsep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># textmode replacements</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">re_escapetext</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl_escapetext</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mathmode replacements</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\(\displaystyle </span><span class="si">%s</span><span class="s2">\)"</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeln"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.writeln">[docs]</a><span class="k">def</span> <span class="nf">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="c1"># every line of a file included with \\input must be terminated with %</span>
    <span class="c1"># if not, latex will create additional vertical spaces for some reason</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"%</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
    <span class="c1"># translate font properties to latex commands, return as string</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">families</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"serif"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\rmfamily"</span><span class="p">,</span> <span class="s2">"sans"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\sffamily"</span><span class="p">,</span>
                <span class="s2">"sans-serif"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\sffamily"</span><span class="p">,</span> <span class="s2">"monospace"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\ttfamily"</span><span class="p">}</span>
    <span class="n">family</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_family</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">family</span> <span class="ow">in</span> <span class="n">families</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">families</span><span class="p">[</span><span class="n">family</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">family</span> <span class="ow">in</span> <span class="n">system_fonts</span> <span class="ow">and</span> <span class="n">get_texcommand</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"pdflatex"</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\setmainfont{</span><span class="si">%s</span><span class="s2">}\rmfamily"</span> <span class="o">%</span> <span class="n">family</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># print warning?</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_size_in_points</span><span class="p">()</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\fontsize{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">))</span>

    <span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"normal"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"italic"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\itshape"</span><span class="p">,</span> <span class="s2">"oblique"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\slshape"</span><span class="p">}</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">styles</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">get_style</span><span class="p">()])</span>

    <span class="n">boldstyles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"semibold"</span><span class="p">,</span> <span class="s2">"demibold"</span><span class="p">,</span> <span class="s2">"demi"</span><span class="p">,</span> <span class="s2">"bold"</span><span class="p">,</span> <span class="s2">"heavy"</span><span class="p">,</span>
                  <span class="s2">"extra bold"</span><span class="p">,</span> <span class="s2">"black"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_weight</span><span class="p">()</span> <span class="ow">in</span> <span class="n">boldstyles</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\bfseries"</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\selectfont"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>


<div class="viewcode-block" id="make_pdf_to_png_converter"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.make_pdf_to_png_converter">[docs]</a><span class="k">def</span> <span class="nf">make_pdf_to_png_converter</span><span class="p">():</span>
    <span class="sd">"""</span>
<span class="sd">    Returns a function that converts a pdf file to a png file.</span>
<span class="sd">    """</span>

    <span class="n">tools_available</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># check for pdftocairo</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">check_output</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="s2">"pdftocairo"</span><span class="p">),</span> <span class="s2">"-v"</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">tools_available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"pdftocairo"</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># check for ghostscript</span>
    <span class="n">gs</span><span class="p">,</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">checkdep_ghostscript</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gs</span><span class="p">:</span>
        <span class="n">tools_available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"gs"</span><span class="p">)</span>

    <span class="c1"># pick converter</span>
    <span class="k">if</span> <span class="s2">"pdftocairo"</span> <span class="ow">in</span> <span class="n">tools_available</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">cairo_convert</span><span class="p">(</span><span class="n">pdffile</span><span class="p">,</span> <span class="n">pngfile</span><span class="p">,</span> <span class="n">dpi</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="s2">"pdftocairo"</span><span class="p">),</span> <span class="s2">"-singlefile"</span><span class="p">,</span> <span class="s2">"-png"</span><span class="p">,</span> <span class="s2">"-r"</span><span class="p">,</span> <span class="s2">"</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">dpi</span><span class="p">,</span>
                   <span class="n">pdffile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cairo_convert</span>
    <span class="k">elif</span> <span class="s2">"gs"</span> <span class="ow">in</span> <span class="n">tools_available</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">gs_convert</span><span class="p">(</span><span class="n">pdffile</span><span class="p">,</span> <span class="n">pngfile</span><span class="p">,</span> <span class="n">dpi</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span>
                   <span class="s1">'-dQUIET'</span><span class="p">,</span> <span class="s1">'-dSAFER'</span><span class="p">,</span> <span class="s1">'-dBATCH'</span><span class="p">,</span> <span class="s1">'-dNOPAUSE'</span><span class="p">,</span> <span class="s1">'-dNOPROMPT'</span><span class="p">,</span>
                   <span class="s1">'-dUseCIEColor'</span><span class="p">,</span> <span class="s1">'-dTextAlphaBits=4'</span><span class="p">,</span>
                   <span class="s1">'-dGraphicsAlphaBits=4'</span><span class="p">,</span> <span class="s1">'-dDOINTERPOLATE'</span><span class="p">,</span>
                   <span class="s1">'-sDEVICE=png16m'</span><span class="p">,</span> <span class="s1">'-sOutputFile=</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">pngfile</span><span class="p">,</span>
                   <span class="s1">'-r</span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">pdffile</span><span class="p">]</span>
            <span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gs_convert</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"No suitable pdf to png renderer found."</span><span class="p">)</span></div>


<div class="viewcode-block" id="LatexError"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexError">[docs]</a><span class="k">class</span> <span class="nc">LatexError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">latex_output</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="n">latex_output</span></div>


<div class="viewcode-block" id="LatexManagerFactory"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManagerFactory">[docs]</a><span class="k">class</span> <span class="nc">LatexManagerFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">previous_instance</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="LatexManagerFactory.get_latex_manager"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManagerFactory.get_latex_manager">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_latex_manager</span><span class="p">():</span>
        <span class="n">texcommand</span> <span class="o">=</span> <span class="n">get_texcommand</span><span class="p">()</span>
        <span class="n">latex_header</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">()</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">LatexManagerFactory</span><span class="o">.</span><span class="n">previous_instance</span>

        <span class="c1"># Check if the previous instance of LatexManager can be reused.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="ow">and</span> <span class="n">prev</span><span class="o">.</span><span class="n">latex_header</span> <span class="o">==</span> <span class="n">latex_header</span>
                <span class="ow">and</span> <span class="n">prev</span><span class="o">.</span><span class="n">texcommand</span> <span class="o">==</span> <span class="n">texcommand</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.debug"</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"reusing LatexManager"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.debug"</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"creating LatexManager"</span><span class="p">)</span>
            <span class="n">new_inst</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="p">()</span>
            <span class="n">LatexManagerFactory</span><span class="o">.</span><span class="n">previous_instance</span> <span class="o">=</span> <span class="n">new_inst</span>
            <span class="k">return</span> <span class="n">new_inst</span></div></div>


<div class="viewcode-block" id="LatexManager"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManager">[docs]</a><span class="k">class</span> <span class="nc">LatexManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    The LatexManager opens an instance of the LaTeX application for</span>
<span class="sd">    determining the metrics of text elements. The LaTeX environment can be</span>
<span class="sd">    modified by setting fonts and/or a custem preamble in the rc parameters.</span>
<span class="sd">    """</span>
    <span class="n">_unclean_instances</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_latex_header</span><span class="p">():</span>
        <span class="n">latex_preamble</span> <span class="o">=</span> <span class="n">get_preamble</span><span class="p">()</span>
        <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="n">get_fontspec</span><span class="p">()</span>
        <span class="c1"># Create LaTeX header with some content, else LaTeX will load some math</span>
        <span class="c1"># fonts later when we don't expect the additional output on stdout.</span>
        <span class="c1"># TODO: is this sufficient?</span>
        <span class="n">latex_header</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">"\documentclass</span><span class="si">{minimal}</span><span class="s2">"</span><span class="p">,</span>
                        <span class="n">latex_preamble</span><span class="p">,</span>
                        <span class="n">latex_fontspec</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{document}</span><span class="s2">"</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"text $math \mu$"</span><span class="p">,</span>  <span class="c1"># force latex to load fonts now</span>
                        <span class="sa">r</span><span class="s2">"\typeout</span><span class="si">{pgf_backend_query_start}</span><span class="s2">"</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">latex_header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cleanup_remaining_instances</span><span class="p">():</span>
        <span class="n">unclean_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">latex_manager</span> <span class="ow">in</span> <span class="n">unclean_instances</span><span class="p">:</span>
            <span class="n">latex_manager</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stdin_writeln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_stdin_utf8</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_stdin_utf8</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_stdin_utf8</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf8"</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="p">):]</span> <span class="o">==</span> <span class="n">exp</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LatexError</span><span class="p">(</span><span class="s2">"LaTeX process halted"</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf8"</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf8"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expect_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">*"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store references for __del__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_os_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutil</span> <span class="o">=</span> <span class="n">shutil</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">rcParams</span><span class="p">[</span><span class="s2">"pgf.debug"</span><span class="p">]</span>

        <span class="c1"># create a tmp directory for running latex, remember to cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">"mpl_pgf_lm_"</span><span class="p">)</span>
        <span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># test the LaTeX setup to ensure a clean startup of the subprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span> <span class="o">=</span> <span class="n">get_texcommand</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_header</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">()</span>
        <span class="n">latex_end</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n\\</span><span class="s2">makeatletter</span><span class="se">\n\\</span><span class="s2">@@end</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latex</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">),</span> <span class="s2">"-halt-on-error"</span><span class="p">],</span>
                                     <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">"Latex command not found. Install </span><span class="si">%r</span><span class="s2"> or change "</span>
                    <span class="s2">"pgf.texsystem to the desired command."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">"Error starting process </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">)</span>
        <span class="n">test_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_header</span> <span class="o">+</span> <span class="n">latex_end</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">latex</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">test_input</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">latex</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LatexError</span><span class="p">(</span><span class="s2">"LaTeX returned an error, probably missing font "</span>
                             <span class="s2">"or error in preamble:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">stdout</span><span class="p">)</span>

        <span class="c1"># open LaTeX process for real work</span>
        <span class="n">latex</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">),</span> <span class="s2">"-halt-on-error"</span><span class="p">],</span>
                                 <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span> <span class="o">=</span> <span class="n">latex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_stdin_utf8</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s2">"utf8"</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="c1"># write header with 'pgf_backend_query_start' token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">())</span>
        <span class="c1"># read all lines until our 'pgf_backend_query_start' token appears</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="s2">"*pgf_backend_query_start"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>

        <span class="c1"># cache for strings already processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latex_stdin_utf8</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"error deleting tmp directory </span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"deleting LatexManager"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

<div class="viewcode-block" id="LatexManager.get_width_height_descent"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManager.get_width_height_descent">[docs]</a>    <span class="k">def</span> <span class="nf">get_width_height_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Get the width, total height and descent for a text typesetted by the</span>
<span class="sd">        current LaTeX environment.</span>
<span class="sd">        """</span>

        <span class="c1"># apply font properties and define textbox</span>
        <span class="n">prop_cmds</span> <span class="o">=</span> <span class="n">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">textbox</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">sbox0{</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">}"</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_cmds</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># check cache</span>
        <span class="k">if</span> <span class="n">textbox</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">[</span><span class="n">textbox</span><span class="p">]</span>

        <span class="c1"># send textbox to LaTeX and wait for prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="n">textbox</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LatexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Error processing '</span><span class="si">{}</span><span class="s2">'</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">"</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">latex_output</span><span class="p">))</span>

        <span class="c1"># typeout width, height and text offset of the last textbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\typeout{\the\wd0,\the\ht0,\the\dp0}"</span><span class="p">)</span>
        <span class="c1"># read answer from latex and advance to the next prompt</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LatexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Error processing '</span><span class="si">{}</span><span class="s2">'</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">"</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">latex_output</span><span class="p">))</span>

        <span class="c1"># parse metrics from the answer string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Error processing '</span><span class="si">{}</span><span class="s2">'</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">"</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">answer</span><span class="p">))</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># the height returned from LaTeX goes from base to top.</span>
        <span class="c1"># the height matplotlib expects goes from bottom to top.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">[</span><span class="n">textbox</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span></div></div>


<div class="viewcode-block" id="RendererPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf">[docs]</a><span class="k">class</span> <span class="nc">RendererPgf</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Creates a new PGF renderer that translates any drawing instruction</span>
<span class="sd">        into text commands to be interpreted in a latex pgfpicture environment.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        figure : `matplotlib.figure.Figure`</span>
<span class="sd">            Matplotlib figure to initialize height, width and dpi from.</span>
<span class="sd">        fh : file-like</span>
<span class="sd">            File handle for the output of the drawing commands.</span>

<span class="sd">        """</span>
        <span class="n">RendererBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">dpi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># get LatexManager instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latexManager</span> <span class="o">=</span> <span class="n">LatexManagerFactory</span><span class="o">.</span><span class="n">get_latex_manager</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dummy</span><span class="p">:</span>
            <span class="c1"># dummy==True deactivate all methods</span>
            <span class="n">nop</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">RendererPgf</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"draw_"</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">nop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if fh does not belong to a filename, deactivate draw_image</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"streamed pgf-code does not support raster "</span>
                              <span class="s2">"graphics, consider using the pgf-to-pdf option"</span><span class="p">,</span>
                              <span class="ne">UserWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">"draw_image"</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>

<div class="viewcode-block" id="RendererPgf.draw_markers"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_markers">[docs]</a>    <span class="k">def</span> <span class="nf">draw_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">marker_path</span><span class="p">,</span> <span class="n">marker_trans</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span>
                     <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># convert from display units to in</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>

        <span class="c1"># set style and clip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>

        <span class="c1"># build marker definition</span>
        <span class="n">bl</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">marker_path</span><span class="o">.</span><span class="n">get_extents</span><span class="p">(</span><span class="n">marker_trans</span><span class="p">)</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">bl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"\pgfsys@defobject</span><span class="si">{currentmarker}</span><span class="s2">"</span>
                <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{"</span> <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_path</span><span class="p">,</span> <span class="n">marker_trans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="n">fill</span><span class="o">=</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"}"</span><span class="p">)</span>

        <span class="c1"># draw marker for each vertex</span>
        <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iter_segments</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@useobject</span><span class="si">{currentmarker}{}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_path"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_path">[docs]</a>    <span class="k">def</span> <span class="nf">draw_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1"># draw the path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="n">fill</span><span class="o">=</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># if present, draw pattern on top</span>
        <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_hatch</span><span class="p">():</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>

            <span class="c1"># combine clip and path for clipping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath</span><span class="si">{clip}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># build pattern definition</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfsys@defobject</span><span class="si">{currentpattern}</span><span class="s2">"</span>
                    <span class="sa">r</span><span class="s2">"{\pgfqpoint</span><span class="si">{0in}{0in}</span><span class="s2">}{\pgfqpoint</span><span class="si">{1in}{1in}</span><span class="s2">}{"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfpathrectangle"</span>
                    <span class="sa">r</span><span class="s2">"{\pgfqpoint</span><span class="si">{0in}{0in}</span><span class="s2">}{\pgfqpoint</span><span class="si">{1in}{1in}</span><span class="s2">}"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath</span><span class="si">{clip}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_hatch_path</span><span class="p">(),</span> <span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"}"</span><span class="p">)</span>
            <span class="c1"># repeat pattern, filling the bounding rect of the path</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
            <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> \
                <span class="n">path</span><span class="o">.</span><span class="n">get_extents</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">xmax</span>
            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ymax</span>
            <span class="n">repx</span><span class="p">,</span> <span class="n">repy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">))</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}"</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repy</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repx</span><span class="p">):</span>
                    <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@useobject</span><span class="si">{currentpattern}{}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@transformshift</span><span class="si">{1in}{0in}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@transformshift{-</span><span class="si">%d</span><span class="s2">in}</span><span class="si">{0in}</span><span class="s2">"</span> <span class="o">%</span> <span class="n">repx</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsys@transformshift</span><span class="si">{0in}{1in}</span><span class="s2">"</span><span class="p">)</span>

            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_pgf_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="c1"># check for clip box</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_rectangle</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfpathrectangle"</span>
                    <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                    <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath</span><span class="si">{clip}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># check for clip path</span>
        <span class="n">clippath</span><span class="p">,</span> <span class="n">clippath_trans</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clippath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">clippath</span><span class="p">,</span> <span class="n">clippath_trans</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath</span><span class="si">{clip}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_pgf_path_styles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">):</span>
        <span class="c1"># cap style</span>
        <span class="n">capstyles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"butt"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetbuttcap"</span><span class="p">,</span>
                     <span class="s2">"round"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetroundcap"</span><span class="p">,</span>
                     <span class="s2">"projecting"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetrectcap"</span><span class="p">}</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">capstyles</span><span class="p">[</span><span class="n">gc</span><span class="o">.</span><span class="n">get_capstyle</span><span class="p">()])</span>

        <span class="c1"># join style</span>
        <span class="n">joinstyles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"miter"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetmiterjoin"</span><span class="p">,</span>
                      <span class="s2">"round"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetroundjoin"</span><span class="p">,</span>
                      <span class="s2">"bevel"</span><span class="p">:</span> <span class="sa">r</span><span class="s2">"\pgfsetbeveljoin"</span><span class="p">}</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">joinstyles</span><span class="p">[</span><span class="n">gc</span><span class="o">.</span><span class="n">get_joinstyle</span><span class="p">()])</span>

        <span class="c1"># filling</span>
        <span class="n">has_fill</span> <span class="o">=</span> <span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_forced_alpha</span><span class="p">():</span>
            <span class="n">fillopacity</span> <span class="o">=</span> <span class="n">strokeopacity</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strokeopacity</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">fillopacity</span> <span class="o">=</span> <span class="n">rgbFace</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_fill</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgbFace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">has_fill</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\definecolor</span><span class="si">{currentfill}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}"</span>
                    <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rgbFace</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetfillcolor</span><span class="si">{currentfill}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_fill</span> <span class="ow">and</span> <span class="n">fillopacity</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetfillopacity{</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="n">fillopacity</span><span class="p">)</span>

        <span class="c1"># linewidth and color</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">*</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="n">latex_in_to_pt</span>
        <span class="n">stroke_rgba</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">()</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetlinewidth{</span><span class="si">%f</span><span class="s2">pt}"</span> <span class="o">%</span> <span class="n">lw</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"\definecolor</span><span class="si">{currentstroke}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}"</span>
                <span class="o">%</span> <span class="n">stroke_rgba</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetstrokecolor</span><span class="si">{currentstroke}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strokeopacity</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetstrokeopacity{</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="n">strokeopacity</span><span class="p">)</span>

        <span class="c1"># line style</span>
        <span class="n">dash_offset</span><span class="p">,</span> <span class="n">dash_list</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_dashes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dash_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetdash</span><span class="si">{}{0pt}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfsetdash{</span><span class="si">%s</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">pt}"</span>
                    <span class="o">%</span> <span class="p">(</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">r</span><span class="s2">"{</span><span class="si">%f</span><span class="s2">pt}"</span> <span class="o">%</span> <span class="n">dash</span> <span class="k">for</span> <span class="n">dash</span> <span class="ow">in</span> <span class="n">dash_list</span><span class="p">),</span>
                       <span class="n">dash_offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_pgf_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="c1"># check for clip box / ignore clip for filled paths</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_rectangle</span><span class="p">()</span> <span class="k">if</span> <span class="n">gc</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># build path</span>
        <span class="k">for</span> <span class="n">points</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iter_segments</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"\pgfpathmoveto{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">:</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfpathclose"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"\pgfpathlineto{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CURVE3</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">px</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">py</span> <span class="o">*</span> <span class="n">f</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"\pgfpathquadraticcurveto"</span>
                        <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                        <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CURVE4</span><span class="p">:</span>
                <span class="n">c1x</span><span class="p">,</span> <span class="n">c1y</span><span class="p">,</span> <span class="n">c2x</span><span class="p">,</span> <span class="n">c2y</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">c1x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c1y</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c2x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c2y</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">px</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">py</span> <span class="o">*</span> <span class="n">f</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"\pgfpathcurveto"</span>
                        <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                        <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                        <span class="sa">r</span><span class="s2">"{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                        <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pgf_path_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"stroke"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"fill"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath{</span><span class="si">%s</span><span class="s2">}"</span> <span class="o">%</span> <span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actions</span><span class="p">))</span>

<div class="viewcode-block" id="RendererPgf.option_scale_image"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.option_scale_image">[docs]</a>    <span class="k">def</span> <span class="nf">option_scale_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        pgf backend supports affine transform of image.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RendererPgf.option_image_nocomposite"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.option_image_nocomposite">[docs]</a>    <span class="k">def</span> <span class="nf">option_image_nocomposite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        return whether to generate a composite image from multiple images on</span>
<span class="sd">        a set of axes</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.composite_image'</span><span class="p">]</span></div>

<div class="viewcode-block" id="RendererPgf.draw_image"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_image">[docs]</a>    <span class="k">def</span> <span class="nf">draw_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># save the images to png files</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fname_img</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">-img</span><span class="si">%d</span><span class="s2">.png"</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">_png</span><span class="o">.</span><span class="n">write_png</span><span class="p">(</span><span class="n">im</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname_img</span><span class="p">))</span>

        <span class="c1"># reference the image in the pgf picture</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>  <span class="c1"># from display coords to inch</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">,</span> <span class="n">tr4</span><span class="p">,</span> <span class="n">tr5</span><span class="p">,</span> <span class="n">tr6</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">frozen</span><span class="p">()</span><span class="o">.</span><span class="n">to_values</span><span class="p">()</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">"\pgfsys@transformcm{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}"</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">tr1</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr2</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr3</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr4</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">tr5</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">tr6</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scale is already included in the transform</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># interpolation in PDF reader</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"\pgftext[left,bottom]"</span>
                <span class="sa">r</span><span class="s2">"{\pgfimage[interpolate=</span><span class="si">%s</span><span class="s2">,width=</span><span class="si">%f</span><span class="s2">in,height=</span><span class="si">%f</span><span class="s2">in]{</span><span class="si">%s</span><span class="s2">}}"</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fname_img</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_tex"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_tex">[docs]</a>    <span class="k">def</span> <span class="nf">draw_tex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="o">=</span><span class="s2">"TeX!"</span><span class="p">,</span> <span class="n">mtext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="p">,</span> <span class="n">mtext</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_text"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_text">[docs]</a>    <span class="k">def</span> <span class="nf">draw_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mtext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># prepare string for tex</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">common_texification</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">prop_cmds</span> <span class="o">=</span> <span class="n">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_cmds</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetfillopacity{</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetstrokeopacity{</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rgb</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\definecolor</span><span class="si">{textcolor}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}"</span> <span class="o">%</span> <span class="n">rgb</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetstrokecolor</span><span class="si">{textcolor}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfsetfillcolor</span><span class="si">{textcolor}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\color</span><span class="si">{textcolor}</span><span class="s2">"</span> <span class="o">+</span> <span class="n">s</span>

        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span>
        <span class="n">text_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mtext</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                 <span class="n">mtext</span><span class="o">.</span><span class="n">get_rotation_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"anchor"</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">mtext</span><span class="o">.</span><span class="n">get_va</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"center_baseline"</span><span class="p">):</span>
            <span class="c1"># if text anchoring can be supported, get the original coordinates</span>
            <span class="c1"># and add alignment information</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mtext</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span><span class="o">.</span><span class="n">transform_point</span><span class="p">(</span><span class="n">mtext</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"x=</span><span class="si">%f</span><span class="s2">in"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"y=</span><span class="si">%f</span><span class="s2">in"</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>

            <span class="n">halign</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"left"</span><span class="p">:</span> <span class="s2">"left"</span><span class="p">,</span> <span class="s2">"right"</span><span class="p">:</span> <span class="s2">"right"</span><span class="p">,</span> <span class="s2">"center"</span><span class="p">:</span> <span class="s2">""</span><span class="p">}</span>
            <span class="n">valign</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"top"</span><span class="p">:</span> <span class="s2">"top"</span><span class="p">,</span> <span class="s2">"bottom"</span><span class="p">:</span> <span class="s2">"bottom"</span><span class="p">,</span>
                      <span class="s2">"baseline"</span><span class="p">:</span> <span class="s2">"base"</span><span class="p">,</span> <span class="s2">"center"</span><span class="p">:</span> <span class="s2">""</span><span class="p">}</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">halign</span><span class="p">[</span><span class="n">mtext</span><span class="o">.</span><span class="n">get_ha</span><span class="p">()])</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valign</span><span class="p">[</span><span class="n">mtext</span><span class="o">.</span><span class="n">get_va</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not, use the text layout provided by matplotlib</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"x=</span><span class="si">%f</span><span class="s2">in"</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"y=</span><span class="si">%f</span><span class="s2">in"</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"left"</span><span class="p">)</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"base"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"rotate=</span><span class="si">%f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">angle</span><span class="p">)</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgftext[</span><span class="si">%s</span><span class="s2">]{</span><span class="si">%s</span><span class="s2">}"</span> <span class="o">%</span> <span class="p">(</span><span class="s2">","</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_args</span><span class="p">),</span> <span class="n">s</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfscope}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.get_text_width_height_descent"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.get_text_width_height_descent">[docs]</a>    <span class="k">def</span> <span class="nf">get_text_width_height_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">ismath</span><span class="p">):</span>
        <span class="c1"># check if the math is supposed to be displaystyled</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">common_texification</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># get text metrics in units of latex pt, convert to display units</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latexManager</span><span class="o">.</span><span class="n">get_width_height_descent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
        <span class="c1"># TODO: this should be latex_pt_to_in instead of mpl_pt_to_in</span>
        <span class="c1"># but having a little bit more space around the text looks better,</span>
        <span class="c1"># plus the bounding box reported by LaTeX is VERY narrow</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="k">return</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">f</span></div>

<div class="viewcode-block" id="RendererPgf.flipy"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.flipy">[docs]</a>    <span class="k">def</span> <span class="nf">flipy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RendererPgf.get_canvas_width_height"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.get_canvas_width_height">[docs]</a>    <span class="k">def</span> <span class="nf">get_canvas_width_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span></div>

<div class="viewcode-block" id="RendererPgf.points_to_pixels"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.points_to_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">points_to_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">points</span> <span class="o">*</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span></div>

<div class="viewcode-block" id="RendererPgf.new_gc"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.new_gc">[docs]</a>    <span class="k">def</span> <span class="nf">new_gc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GraphicsContextPgf</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="GraphicsContextPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.GraphicsContextPgf">[docs]</a><span class="k">class</span> <span class="nc">GraphicsContextPgf</span><span class="p">(</span><span class="n">GraphicsContextBase</span><span class="p">):</span>
    <span class="k">pass</span></div>

<span class="c1">########################################################################</span>


<div class="viewcode-block" id="TmpDirCleaner"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner">[docs]</a><span class="k">class</span> <span class="nc">TmpDirCleaner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">remaining_tmpdirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="TmpDirCleaner.add"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner.add">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">remaining_tmpdirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="TmpDirCleaner.cleanup_remaining_tmpdirs"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner.cleanup_remaining_tmpdirs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup_remaining_tmpdirs</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tmpdir</span> <span class="ow">in</span> <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">remaining_tmpdirs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"error deleting tmp directory </span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="n">tmpdir</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FigureCanvasPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf">[docs]</a><span class="k">class</span> <span class="nc">FigureCanvasPgf</span><span class="p">(</span><span class="n">FigureCanvasBase</span><span class="p">):</span>
    <span class="n">filetypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"pgf"</span><span class="p">:</span> <span class="s2">"LaTeX PGF picture"</span><span class="p">,</span>
                 <span class="s2">"pdf"</span><span class="p">:</span> <span class="s2">"LaTeX compiled PGF picture"</span><span class="p">,</span>
                 <span class="s2">"png"</span><span class="p">:</span> <span class="s2">"Portable Network Graphics"</span><span class="p">,</span> <span class="p">}</span>

<div class="viewcode-block" id="FigureCanvasPgf.get_default_filetype"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.get_default_filetype">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_filetype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'pdf'</span></div>

    <span class="k">def</span> <span class="nf">_print_pgf_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dryrun"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">header_text</span> <span class="o">=</span> <span class="s2">"""</span><span class="si">%%</span><span class="s2"> Creator: Matplotlib, PGF backend</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> To include the figure in your LaTeX document, write</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">input{&lt;filename&gt;.pgf}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> Make sure the required packages are loaded in your preamble</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{pgf}</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> Figures using additional raster images can only be included by </span><span class="se">\\</span><span class="s2">input if</span>
<span class="si">%%</span><span class="s2"> they are in the same directory as the main LaTeX file. For loading figures</span>
<span class="si">%%</span><span class="s2"> from other directories you can use the `import` package</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{import}</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> and then include the figures with</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">import{&lt;path to file&gt;}{&lt;filename&gt;.pgf}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="s2">"""</span>

        <span class="c1"># append the preamble used by the backend as a comment for debugging</span>
        <span class="n">header_info_preamble</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"</span><span class="si">%%</span><span class="s2"> Matplotlib used the following preamble"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_preamble</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"</span><span class="si">%%</span><span class="s2">   "</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_fontspec</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"</span><span class="si">%%</span><span class="s2">   "</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"</span><span class="si">%%</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">header_info_preamble</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header_info_preamble</span><span class="p">)</span>

        <span class="c1"># get figure size in inch</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>

        <span class="c1"># create pgfpicture environment and write the pgf code</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_text</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_info_preamble</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begingroup"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\makeatletter"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\begin</span><span class="si">{pgfpicture}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"\pgfpathrectangle{\pgfpointorigin}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}"</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\pgfusepath{use as bounding box, clip}"</span><span class="p">)</span>
        <span class="n">_bbox_inches_restore</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"bbox_inches_restore"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">renderer</span> <span class="o">=</span> <span class="n">MixedModeRenderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span>
                                     <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">fh</span><span class="p">),</span>
                                     <span class="n">bbox_inches_restore</span><span class="o">=</span><span class="n">_bbox_inches_restore</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="c1"># end the pgfpicture environment</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\end</span><span class="si">{pgfpicture}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\makeatother"</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">"\endgroup"</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_pgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_pgf">[docs]</a>    <span class="k">def</span> <span class="nf">print_pgf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Output pgf commands for drawing the figure so it can be included and</span>
<span class="sd">        rendered in latex documents.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dryrun"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># figure out where the pgf is to be written to</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_writable_file_like</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)(</span><span class="n">fname_or_fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"filename must be a path"</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_pdf_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create temporary directory for compiling the figure</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">"mpl_pgf_"</span><span class="p">)</span>
            <span class="n">fname_pgf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">"figure.pgf"</span><span class="p">)</span>
            <span class="n">fname_tex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">"figure.tex"</span><span class="p">)</span>
            <span class="n">fname_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">"figure.pdf"</span><span class="p">)</span>

            <span class="c1"># print figure to pgf and compile it with latex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_pgf</span><span class="p">(</span><span class="n">fname_pgf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">latex_preamble</span> <span class="o">=</span> <span class="n">get_preamble</span><span class="p">()</span>
            <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="n">get_fontspec</span><span class="p">()</span>
            <span class="n">latexcode</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="se">\\</span><span class="s2">documentclass[12pt]</span><span class="si">{minimal}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">usepackage[paperwidth=</span><span class="si">%f</span><span class="s2">in, paperheight=</span><span class="si">%f</span><span class="s2">in, margin=0in]</span><span class="si">{geometry}</span><span class="s2"></span>
<span class="si">%s</span><span class="s2"></span>
<span class="si">%s</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">usepackage</span><span class="si">{pgf}</span><span class="s2"></span>

<span class="se">\\</span><span class="s2">begin</span><span class="si">{document}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">centering</span>
<span class="se">\\</span><span class="s2">input</span><span class="si">{figure.pgf}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">end</span><span class="si">{document}</span><span class="s2">"""</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">latex_preamble</span><span class="p">,</span> <span class="n">latex_fontspec</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname_tex</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh_tex</span><span class="p">:</span>
                <span class="n">fh_tex</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">latexcode</span><span class="p">)</span>

            <span class="n">texcommand</span> <span class="o">=</span> <span class="n">get_texcommand</span><span class="p">()</span>
            <span class="n">cmdargs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">texcommand</span><span class="p">),</span> <span class="s2">"-interaction=nonstopmode"</span><span class="p">,</span>
                       <span class="s2">"-halt-on-error"</span><span class="p">,</span> <span class="s2">"figure.tex"</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">check_output</span><span class="p">(</span><span class="n">cmdargs</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">"</span><span class="si">%s</span><span class="s2"> was not able to process your file.</span><span class="se">\n\n</span><span class="s2">Full log:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">texcommand</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>

            <span class="c1"># copy file contents to target</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh_src</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fh_src</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_pdf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">print_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Use LaTeX to compile a Pgf generated figure to PDF.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dryrun"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># figure out where the pdf is to be written to</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_pdf_to_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_writable_file_like</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pdf_to_fh</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"filename must be a path or a file-like object"</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_png_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">make_pdf_to_png_converter</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create temporary directory for pdf creation and png conversion</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">"mpl_pgf_"</span><span class="p">)</span>
            <span class="n">fname_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">"figure.pdf"</span><span class="p">)</span>
            <span class="n">fname_png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">"figure.png"</span><span class="p">)</span>
            <span class="c1"># create pdf and try to convert it to png</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_pdf</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">converter</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="n">fname_png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="c1"># copy file contents to target</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_png</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh_src</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fh_src</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_png"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_png">[docs]</a>    <span class="k">def</span> <span class="nf">print_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Use LaTeX to compile a pgf figure to pdf and convert it to png.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dryrun"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_png_to_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_writable_file_like</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_png_to_fh</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"filename must be a path or a file-like object"</span><span class="p">)</span></div>

<div class="viewcode-block" id="FigureCanvasPgf.get_renderer"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.get_renderer">[docs]</a>    <span class="k">def</span> <span class="nf">get_renderer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FigureManagerPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureManagerPgf">[docs]</a><span class="k">class</span> <span class="nc">FigureManagerPgf</span><span class="p">(</span><span class="n">FigureManagerBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">FigureManagerBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>


<span class="nd">@_Backend</span><span class="o">.</span><span class="n">export</span>
<span class="k">class</span> <span class="nc">_BackendPgf</span><span class="p">(</span><span class="n">_Backend</span><span class="p">):</span>
    <span class="n">FigureCanvas</span> <span class="o">=</span> <span class="n">FigureCanvasPgf</span>
    <span class="n">FigureManager</span> <span class="o">=</span> <span class="n">FigureManagerPgf</span>


<span class="k">def</span> <span class="nf">_cleanup_all</span><span class="p">():</span>
    <span class="n">LatexManager</span><span class="o">.</span><span class="n">_cleanup_remaining_instances</span><span class="p">()</span>
    <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">cleanup_remaining_tmpdirs</span><span class="p">()</span>

<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">_cleanup_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div class="footer">
        © Copyright 2002 - 2012 John Hunter, Darren Dale, Eric Firing, Michael Droettboom and the Matplotlib development team; 2012 - 2018 The Matplotlib development team.
        <br/>
      Last updated on Jun 28, 2018.
	Created using
	<ahref>Sphinx 1.7.5.
	Doc version v2.2.2-101-g15e1eadd0.
    </ahref></div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55954603-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
<footer>
<!--Flipcause Integration v3.0// Flipcause Integration Instructions:
Install the following code block once in the website Header (after <head> tag) -->
<style>

.fc-black_overlay{
display:none; position: fixed; z-index:1000001; top: 0%;left: 0%;width: 100%;height: 100%;
background-color: black; filter: alpha(opacity=50); cursor:pointer; opacity:0.5;
}

.fc-white_content {
opacity:1; display:none; margin-top: -320px; margin-left: -485px; width:970px; height:640px;
position:fixed; top:50%; left:50%; border: none;z-index:1000002;overflow: auto;
}

.fc-main-box{
opacity:1; display:none; margin:15px auto 0 auto; width:930px; position:relative; z-index:1000003;
}

.fc-widget_close{
opacity:1; content:url(http://i1338.photobucket.com/albums/o691/WeCause/X_zpse4a7e538.png);
position:absolute; z-index=1000004; right:-16px; top:-16px; display:block; cursor:pointer;
}

.floating_button{
display: block; margin-top: 0px; margin-left: 0px; width:auto ; height: auto;
position:fixed; z-index:999999; overflow: auto;
}

@keyframes backfadesin {
   from { opacity:0; }
   to {opacity:.5;}
}

@-moz-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@-webkit-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@-o-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}


@-ms-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; transform: translateY(20px);}
   100% {opacity: 1; transform: translateY(0);}
}

@-moz-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -moz-transform: translateY(20px);}
   100% {opacity: 1; -moz-transform: translateY(0);}
}

@-webkit-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -webkit-transform: translateY(20px);}
   100% {opacity: 1; -webkit-transform: translateY(0);}
}

@-o-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -o-transform: translateY(20px);}
   100% {opacity: 1; -o-transform: translateY(0);}
}

@-ms-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -ms-transform: translateY(20px);}
   100% {opacity: 1; -ms-transform: translateY(0);}
}

</style>
<div class="fc-black_overlay" id="fc-fade" onclick="close_window()"></div>
<div class="fc-white_content" id="fc-light">
<div class="fc-main-box" id="fc-main">
<div class="fc-widget_close" id="fc-close" onclick="close_window()">
</div><iframe height="580" id="fc-myFrame" iframe="" scrolling="no" src="" style="border: 0;
border-radius:5px 5px 5px 5px; box-shadow:0 0 8px rgba(0, 0, 0, 0.5);" width="925"></iframe></div>
</div>
<!--END Flipcause Main Integration Code-->
</footer>
</html>