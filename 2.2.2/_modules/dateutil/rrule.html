<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>dateutil.rrule — Matplotlib 2.2.2 documentation</title>
<link href="../../_static/mpl.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/gallery.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
<script src="../../_static/jquery.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<link href="../../_static/opensearch.xml" rel="search" title="Search within Matplotlib 2.2.2 documentation" type="application/opensearchdescription+xml"/>
<link href="../../_static/favicon.ico" rel="shortcut icon"/>
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="../../index.html" rel="top" title="Matplotlib 2.2.2 documentation"/>
<link href="../index.html" rel="up" title="Module code"/>
<link href="https://matplotlib.org/_modules/dateutil/rrule.html" rel="canonical"/>
<link href="https://matplotlib.org/_modules/dateutil/rrule.html" rel="canonical"/></head>
<body><div id="old-version-banner">
            You are reading documentation for a static version of Matplotlib.
            <a href="https://matplotlib.org/_modules/dateutil/rrule.html">This page may have been updated.</a>
</div>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px; position: relative;">
<a href="../../index.html">
<div style="float: left; position: absolute; width: 496px; bottom: 0; padding-bottom: 24px"><span style="float: right; color: #789; background: white">Version 2.2.2</span></div>
<img alt="matplotlib" border="0" height="125px" src="../../_static/logo2.png"/></a>
<!-- The "Fork me on github" ribbon -->
<div id="forkongithub"><a href="https://github.com/matplotlib/matplotlib">Fork me on GitHub</a></div>
</div>
<div class="related">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li><a href="../../index.html">home</a>| </li>
<li><a href="../../gallery/index.html">examples</a>| </li>
<li><a href="../../tutorials/index.html">tutorials</a>| </li>
<li><a href="../../api/pyplot_summary.html">pyplot</a>| </li>
<li><a href="../../contents.html">docs</a> »</li>
<li><a accesskey="U" href="../index.html">Module code</a> »</li>
</ul>
</div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div id="searchbox" role="search" style="display: none">
<h3>Quick search</h3>
<div class="searchformwrapper">
<form action="../../search.html" class="search" method="get">
<input name="q" type="text"/>
<input type="submit" value="Go"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../contents.html">Documentation overview</a><ul>
<li><a href="../index.html">Module code</a><ul>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body">
<h1>Source code for dateutil.rrule</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""</span>
<span class="sd">The rrule module offers a small, complete, and very fast, implementation of</span>
<span class="sd">the recurrence rules documented in the</span>
<span class="sd">`iCalendar RFC &lt;https://tools.ietf.org/html/rfc5545&gt;`_,</span>
<span class="sd">including support for caching of results.</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">gcd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">fractions</span> <span class="k">import</span> <span class="n">gcd</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">advance_iterator</span><span class="p">,</span> <span class="n">integer_types</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">_thread</span><span class="p">,</span> <span class="nb">range</span>
<span class="kn">import</span> <span class="nn">heapq</span>

<span class="kn">from</span> <span class="nn">._common</span> <span class="k">import</span> <span class="n">weekday</span> <span class="k">as</span> <span class="n">weekdaybase</span>
<span class="kn">from</span> <span class="nn">.tz</span> <span class="k">import</span> <span class="n">tzutc</span><span class="p">,</span> <span class="n">tzlocal</span>

<span class="c1"># For warning about deprecation of until and count</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"rrule"</span><span class="p">,</span> <span class="s2">"rruleset"</span><span class="p">,</span> <span class="s2">"rrulestr"</span><span class="p">,</span>
           <span class="s2">"YEARLY"</span><span class="p">,</span> <span class="s2">"MONTHLY"</span><span class="p">,</span> <span class="s2">"WEEKLY"</span><span class="p">,</span> <span class="s2">"DAILY"</span><span class="p">,</span>
           <span class="s2">"HOURLY"</span><span class="p">,</span> <span class="s2">"MINUTELY"</span><span class="p">,</span> <span class="s2">"SECONDLY"</span><span class="p">,</span>
           <span class="s2">"MO"</span><span class="p">,</span> <span class="s2">"TU"</span><span class="p">,</span> <span class="s2">"WE"</span><span class="p">,</span> <span class="s2">"TH"</span><span class="p">,</span> <span class="s2">"FR"</span><span class="p">,</span> <span class="s2">"SA"</span><span class="p">,</span> <span class="s2">"SU"</span><span class="p">]</span>

<span class="c1"># Every mask is 7 days longer to handle cross-year weekly periods.</span>
<span class="n">M366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">29</span><span class="o">+</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span>
                 <span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">*</span><span class="mi">31</span><span class="o">+</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
<span class="n">M365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">M366MASK</span><span class="p">)</span>
<span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
<span class="n">MDAY366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M31</span><span class="o">+</span><span class="n">M29</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">MDAY365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MDAY366MASK</span><span class="p">)</span>
<span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">NMDAY366MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M31</span><span class="o">+</span><span class="n">M29</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M30</span><span class="o">+</span><span class="n">M31</span><span class="o">+</span><span class="n">M31</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">NMDAY365MASK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">NMDAY366MASK</span><span class="p">)</span>
<span class="n">M366RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
<span class="n">M365RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">334</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span>
<span class="n">WDAYMASK</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">55</span>
<span class="k">del</span> <span class="n">M29</span><span class="p">,</span> <span class="n">M30</span><span class="p">,</span> <span class="n">M31</span><span class="p">,</span> <span class="n">M365MASK</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">MDAY365MASK</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">NMDAY365MASK</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span>
<span class="n">MDAY365MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MDAY365MASK</span><span class="p">)</span>
<span class="n">M365MASK</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">M365MASK</span><span class="p">)</span>

<span class="n">FREQNAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'YEARLY'</span><span class="p">,</span> <span class="s1">'MONTHLY'</span><span class="p">,</span> <span class="s1">'WEEKLY'</span><span class="p">,</span> <span class="s1">'DAILY'</span><span class="p">,</span> <span class="s1">'HOURLY'</span><span class="p">,</span> <span class="s1">'MINUTELY'</span><span class="p">,</span> <span class="s1">'SECONDLY'</span><span class="p">]</span>

<span class="p">(</span><span class="n">YEARLY</span><span class="p">,</span>
 <span class="n">MONTHLY</span><span class="p">,</span>
 <span class="n">WEEKLY</span><span class="p">,</span>
 <span class="n">DAILY</span><span class="p">,</span>
 <span class="n">HOURLY</span><span class="p">,</span>
 <span class="n">MINUTELY</span><span class="p">,</span>
 <span class="n">SECONDLY</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Imported on demand.</span>
<span class="n">easter</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">weekday</span><span class="p">(</span><span class="n">weekdaybase</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    This version of weekday does not allow n = 0.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wkday</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Can't create weekday with n==0"</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">weekday</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">wkday</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="n">MO</span><span class="p">,</span> <span class="n">TU</span><span class="p">,</span> <span class="n">WE</span><span class="p">,</span> <span class="n">TH</span><span class="p">,</span> <span class="n">FR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SU</span> <span class="o">=</span> <span class="n">weekdays</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_invalidates_cache</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Decorator for rruleset methods which may invalidate the</span>
<span class="sd">    cached length.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">inner_func</span>


<span class="k">class</span> <span class="nc">rrulebase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">allocate_lock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_cached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_iter_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="n">acquire</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">acquire</span>
        <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_lock</span><span class="o">.</span><span class="n">release</span>
        <span class="k">while</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
                <span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                        <span class="n">cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_gen</span> <span class="o">=</span> <span class="n">gen</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">release</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
                                             <span class="n">item</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">item</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># __len__() introduces a large performance penality.</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">""" Returns the number of recurrences in this set. It will have go</span>
<span class="sd">            trough the whole recurrence, if this hasn't been done before. """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">""" Returns the last recurrence before the given datetime instance. The</span>
<span class="sd">            inc keyword defines what happens if dt is an occurrence. With</span>
<span class="sd">            inc=True, if dt itself is an occurrence, it will be returned. """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">last</span>

    <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">""" Returns the first recurrence after the given datetime instance. The</span>
<span class="sd">            inc keyword defines what happens if dt is an occurrence. With</span>
<span class="sd">            inc=True, if dt itself is an occurrence, it will be returned.  """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">dt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">xafter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Generator which yields up to `count` recurrences after the given</span>
<span class="sd">        datetime instance, equivalent to `after`.</span>

<span class="sd">        :param dt:</span>
<span class="sd">            The datetime at which to start generating recurrences.</span>

<span class="sd">        :param count:</span>
<span class="sd">            The maximum number of recurrences to generate. If `None` (default),</span>
<span class="sd">            dates are generated until the recurrence rule is exhausted.</span>

<span class="sd">        :param inc:</span>
<span class="sd">            If `dt` is an instance of the rule and `inc` is `True`, it is</span>
<span class="sd">            included in the output.</span>

<span class="sd">        :yields: Yields a sequence of `datetime` objects.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Select the comparison function</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dtc</span><span class="p">:</span> <span class="n">dc</span> <span class="o">&gt;=</span> <span class="n">dtc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dc</span><span class="p">,</span> <span class="n">dtc</span><span class="p">:</span> <span class="n">dc</span> <span class="o">&gt;</span> <span class="n">dtc</span>

        <span class="c1"># Generate dates</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">yield</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">""" Returns all the occurrences of the rrule between after and before.</span>
<span class="sd">        The inc keyword defines what happens if after and/or before are</span>
<span class="sd">        themselves occurrences. With inc=True, they will be included in the</span>
<span class="sd">        list, if they are found in the recurrence set. """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_complete</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">before</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">after</span><span class="p">:</span>
                        <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">before</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">after</span><span class="p">:</span>
                        <span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span>


<div class="viewcode-block" id="rrule"><a class="viewcode-back" href="../../api/dates_api.html#matplotlib.dates.rrule">[docs]</a><span class="k">class</span> <span class="nc">rrule</span><span class="p">(</span><span class="n">rrulebase</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    That's the base of the rrule operation. It accepts all the keywords</span>
<span class="sd">    defined in the RFC as its constructor parameters (except byday,</span>
<span class="sd">    which was renamed to byweekday) and more. The constructor prototype is::</span>

<span class="sd">            rrule(freq)</span>

<span class="sd">    Where freq must be one of YEARLY, MONTHLY, WEEKLY, DAILY, HOURLY, MINUTELY,</span>
<span class="sd">    or SECONDLY.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Per RFC section 3.3.10, recurrence instances falling on invalid dates</span>
<span class="sd">        and times are ignored rather than coerced:</span>

<span class="sd">            Recurrence rules may generate recurrence instances with an invalid</span>
<span class="sd">            date (e.g., February 30) or nonexistent local time (e.g., 1:30 AM</span>
<span class="sd">            on a day where the local time is moved forward by an hour at 1:00</span>
<span class="sd">            AM).  Such recurrence instances MUST be ignored and MUST NOT be</span>
<span class="sd">            counted as part of the recurrence set.</span>

<span class="sd">        This can lead to possibly surprising behavior when, for example, the</span>
<span class="sd">        start date occurs at the end of the month:</span>

<span class="sd">        &gt;&gt;&gt; from dateutil.rrule import rrule, MONTHLY</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; start_date = datetime(2014, 12, 31)</span>
<span class="sd">        &gt;&gt;&gt; list(rrule(freq=MONTHLY, count=4, dtstart=start_date))</span>
<span class="sd">        ... # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        [datetime.datetime(2014, 12, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 1, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 3, 31, 0, 0),</span>
<span class="sd">         datetime.datetime(2015, 5, 31, 0, 0)]</span>

<span class="sd">    Additionally, it supports the following keyword arguments:</span>

<span class="sd">    :param dtstart:</span>
<span class="sd">        The recurrence start. Besides being the base for the recurrence,</span>
<span class="sd">        missing parameters in the final recurrence instances will also be</span>
<span class="sd">        extracted from this date. If not given, datetime.now() will be used</span>
<span class="sd">        instead.</span>
<span class="sd">    :param interval:</span>
<span class="sd">        The interval between each freq iteration. For example, when using</span>
<span class="sd">        YEARLY, an interval of 2 means once every two years, but with HOURLY,</span>
<span class="sd">        it means once every two hours. The default interval is 1.</span>
<span class="sd">    :param wkst:</span>
<span class="sd">        The week start day. Must be one of the MO, TU, WE constants, or an</span>
<span class="sd">        integer, specifying the first day of the week. This will affect</span>
<span class="sd">        recurrences based on weekly periods. The default week start is got</span>
<span class="sd">        from calendar.firstweekday(), and may be modified by</span>
<span class="sd">        calendar.setfirstweekday().</span>
<span class="sd">    :param count:</span>
<span class="sd">        How many occurrences will be generated.</span>

<span class="sd">        .. note::</span>
<span class="sd">            As of version 2.5.0, the use of the ``until`` keyword together</span>
<span class="sd">            with the ``count`` keyword is deprecated per RFC-5545 Sec. 3.3.10.</span>
<span class="sd">    :param until:</span>
<span class="sd">        If given, this must be a datetime instance, that will specify the</span>
<span class="sd">        limit of the recurrence. The last recurrence in the rule is the greatest</span>
<span class="sd">        datetime that is less than or equal to the value specified in the</span>
<span class="sd">        ``until`` parameter.</span>

<span class="sd">        .. note::</span>
<span class="sd">            As of version 2.5.0, the use of the ``until`` keyword together</span>
<span class="sd">            with the ``count`` keyword is deprecated per RFC-5545 Sec. 3.3.10.</span>
<span class="sd">    :param bysetpos:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        positive or negative. Each given integer will specify an occurrence</span>
<span class="sd">        number, corresponding to the nth occurrence of the rule inside the</span>
<span class="sd">        frequency period. For example, a bysetpos of -1 if combined with a</span>
<span class="sd">        MONTHLY frequency, and a byweekday of (MO, TU, WE, TH, FR), will</span>
<span class="sd">        result in the last work day of every month.</span>
<span class="sd">    :param bymonth:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the months to apply the recurrence to.</span>
<span class="sd">    :param bymonthday:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the month days to apply the recurrence to.</span>
<span class="sd">    :param byyearday:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the year days to apply the recurrence to.</span>
<span class="sd">    :param byeaster:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        positive or negative. Each integer will define an offset from the</span>
<span class="sd">        Easter Sunday. Passing the offset 0 to byeaster will yield the Easter</span>
<span class="sd">        Sunday itself. This is an extension to the RFC specification.</span>
<span class="sd">    :param byweekno:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the week numbers to apply the recurrence to. Week numbers</span>
<span class="sd">        have the meaning described in ISO8601, that is, the first week of</span>
<span class="sd">        the year is that containing at least four days of the new year.</span>
<span class="sd">    :param byweekday:</span>
<span class="sd">        If given, it must be either an integer (0 == MO), a sequence of</span>
<span class="sd">        integers, one of the weekday constants (MO, TU, etc), or a sequence</span>
<span class="sd">        of these constants. When given, these variables will define the</span>
<span class="sd">        weekdays where the recurrence will be applied. It's also possible to</span>
<span class="sd">        use an argument n for the weekday instances, which will mean the nth</span>
<span class="sd">        occurrence of this weekday in the period. For example, with MONTHLY,</span>
<span class="sd">        or with YEARLY and BYMONTH, using FR(+1) in byweekday will specify the</span>
<span class="sd">        first friday of the month where the recurrence happens. Notice that in</span>
<span class="sd">        the RFC documentation, this is specified as BYDAY, but was renamed to</span>
<span class="sd">        avoid the ambiguity of that keyword.</span>
<span class="sd">    :param byhour:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the hours to apply the recurrence to.</span>
<span class="sd">    :param byminute:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the minutes to apply the recurrence to.</span>
<span class="sd">    :param bysecond:</span>
<span class="sd">        If given, it must be either an integer, or a sequence of integers,</span>
<span class="sd">        meaning the seconds to apply the recurrence to.</span>
<span class="sd">    :param cache:</span>
<span class="sd">        If given, it must be a boolean value specifying to enable or disable</span>
<span class="sd">        caching of results. If you will use the same rrule instance multiple</span>
<span class="sd">        times, enabling caching will improve the performance considerably.</span>
<span class="sd">     """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wkst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bysetpos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bymonth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bymonthday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byyearday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byeaster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">byweekno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byweekday</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">byhour</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byminute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bysecond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">rrule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">easter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dtstart</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="n">until</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
                <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">until</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>           
                <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">dtstart</span><span class="o">.</span><span class="n">toordinal</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span> <span class="o">=</span> <span class="n">dtstart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tzinfo</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">tzinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Cache the original byxxx rules, if they are provided, as the _byxxx</span>
        <span class="c1"># attributes do not necessarily map to the inputs, and this can be</span>
        <span class="c1"># a problem in generating the strings. Only store things if they've</span>
        <span class="c1"># been supplied (the string retrieval will just use .get())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">until</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">until</span><span class="o">.</span><span class="n">toordinal</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_until</span> <span class="o">=</span> <span class="n">until</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># According to RFC5545 Section 3.3.10:</span>
                <span class="c1"># https://tools.ietf.org/html/rfc5545#section-3.3.10</span>
                <span class="c1">#</span>
                <span class="c1"># &gt; If the "DTSTART" property is specified as a date with UTC</span>
                <span class="c1"># &gt; time or a date with local time and time zone reference,</span>
                <span class="c1"># &gt; then the UNTIL rule part MUST be specified as a date with</span>
                <span class="c1"># &gt; UTC time.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">'RRULE UNTIL values must be specified in UTC when DTSTART '</span>
                    <span class="s1">'is timezone-aware'</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">until</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">"Using both 'count' and 'until' is inconsistent with RFC 5545"</span>
                 <span class="s2">" and has been deprecated in dateutil. Future versions will "</span>
                 <span class="s2">"raise an error."</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wkst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">firstweekday</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wkst</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">wkst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span> <span class="o">=</span> <span class="n">wkst</span><span class="o">.</span><span class="n">weekday</span>

        <span class="k">if</span> <span class="n">bysetpos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bysetpos</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bysetpos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">366</span> <span class="o">&lt;=</span> <span class="n">bysetpos</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"bysetpos must be between 1 and 366, "</span>
                                 <span class="s2">"or between -366 and -1"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">bysetpos</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bysetpos</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">366</span> <span class="o">&lt;=</span> <span class="n">pos</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"bysetpos must be between 1 and 366, "</span>
                                     <span class="s2">"or between -366 and -1"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bysetpos'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">byweekno</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byyearday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bymonthday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">byweekday</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byeaster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bymonth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bymonth</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">month</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bymonth'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bymonthday'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bymonthday'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">WEEKLY</span><span class="p">:</span>
                <span class="n">byweekday</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byweekday'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># bymonth</span>
        <span class="k">if</span> <span class="n">bymonth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bymonth</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bymonth</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymonth</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bymonth</span><span class="p">)))</span>

            <span class="k">if</span> <span class="s1">'bymonth'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bymonth'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span>

        <span class="c1"># byyearday</span>
        <span class="k">if</span> <span class="n">byyearday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byyearday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byyearday</span> <span class="o">=</span> <span class="p">(</span><span class="n">byyearday</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">byyearday</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byyearday'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span>

        <span class="c1"># byeaster</span>
        <span class="k">if</span> <span class="n">byeaster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">easter</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">easter</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byeaster</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="p">(</span><span class="n">byeaster</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">byeaster</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byeaster'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># bymonthday</span>
        <span class="k">if</span> <span class="n">bymonthday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bymonthday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bymonthday</span> <span class="o">=</span> <span class="p">(</span><span class="n">bymonthday</span><span class="p">,)</span>

            <span class="n">bymonthday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bymonthday</span><span class="p">)</span>            <span class="c1"># Ensure it's unique</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>

            <span class="c1"># Storing positive numbers first, then negative numbers</span>
            <span class="k">if</span> <span class="s1">'bymonthday'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bymonthday'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span><span class="p">))</span>

        <span class="c1"># byweekno</span>
        <span class="k">if</span> <span class="n">byweekno</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byweekno</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byweekno</span> <span class="o">=</span> <span class="p">(</span><span class="n">byweekno</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">byweekno</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byweekno'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span>

        <span class="c1"># byweekday / bynweekday</span>
        <span class="k">if</span> <span class="n">byweekday</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it's one of the valid non-sequence types, convert to a</span>
            <span class="c1"># single-element sequence before the iterator that builds the</span>
            <span class="c1"># byweekday set.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byweekday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">byweekday</span><span class="p">,</span> <span class="s2">"n"</span><span class="p">):</span>
                <span class="n">byweekday</span> <span class="o">=</span> <span class="p">(</span><span class="n">byweekday</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">byweekday</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wday</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wday</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span> <span class="ow">or</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">MONTHLY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wday</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">wday</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">))</span>
                <span class="n">orig_byweekday</span> <span class="o">=</span> <span class="p">[</span><span class="n">weekday</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_byweekday</span> <span class="o">=</span> <span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">))</span>
                <span class="n">orig_bynweekday</span> <span class="o">=</span> <span class="p">[</span><span class="n">weekday</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orig_bynweekday</span> <span class="o">=</span> <span class="p">()</span>

            <span class="k">if</span> <span class="s1">'byweekday'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byweekday'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                    <span class="n">orig_byweekday</span><span class="p">,</span> <span class="n">orig_bynweekday</span><span class="p">))</span>

        <span class="c1"># byhour</span>
        <span class="k">if</span> <span class="n">byhour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="p">{</span><span class="n">dtstart</span><span class="o">.</span><span class="n">hour</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byhour</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byhour</span> <span class="o">=</span> <span class="p">(</span><span class="n">byhour</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                      <span class="n">byxxx</span><span class="o">=</span><span class="n">byhour</span><span class="p">,</span>
                                                      <span class="n">base</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">byhour</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byhour'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span>

        <span class="c1"># byminute</span>
        <span class="k">if</span> <span class="n">byminute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="p">{</span><span class="n">dtstart</span><span class="o">.</span><span class="n">minute</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byminute</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">byminute</span> <span class="o">=</span> <span class="p">(</span><span class="n">byminute</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                                        <span class="n">byxxx</span><span class="o">=</span><span class="n">byminute</span><span class="p">,</span>
                                                        <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">byminute</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'byminute'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span>

        <span class="c1"># bysecond</span>
        <span class="k">if</span> <span class="n">bysecond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtstart</span><span class="o">.</span><span class="n">second</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bysecond</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">bysecond</span> <span class="o">=</span> <span class="p">(</span><span class="n">bysecond</span><span class="p">,)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bysecond</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__construct_byset</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dtstart</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                                                        <span class="n">byxxx</span><span class="o">=</span><span class="n">bysecond</span><span class="p">,</span>
                                                        <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bysecond</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">[</span><span class="s1">'bysecond'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">&gt;=</span> <span class="n">HOURLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                                          <span class="n">tzinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Output a string that would generate this RRULE if passed to rrulestr.</span>
<span class="sd">        This is mostly compatible with RFC5545, except for the</span>
<span class="sd">        dateutil-specific extension BYEASTER.</span>
<span class="sd">        """</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'DTSTART:%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S'</span><span class="p">))</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'FREQ='</span> <span class="o">+</span> <span class="n">FREQNAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'INTERVAL='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'WKST='</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">weekday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'COUNT='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'UNTIL=%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S'</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'byweekday'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The str() method on weekday objects doesn't generate</span>
            <span class="c1"># RFC5545-compliant strings, so we should modify that.</span>
            <span class="n">original_rule</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">)</span>
            <span class="n">wday_strings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">original_rule</span><span class="p">[</span><span class="s1">'byweekday'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                    <span class="n">wday_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'</span><span class="si">{n:+d}{wday}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">wday</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">wday</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">wday</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wday_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">wday</span><span class="p">))</span>

            <span class="n">original_rule</span><span class="p">[</span><span class="s1">'byweekday'</span><span class="p">]</span> <span class="o">=</span> <span class="n">wday_strings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span>

        <span class="n">partfmt</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{name}</span><span class="s1">=</span><span class="si">{vals}</span><span class="s1">'</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">'BYSETPOS'</span><span class="p">,</span> <span class="s1">'bysetpos'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYMONTH'</span><span class="p">,</span> <span class="s1">'bymonth'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYMONTHDAY'</span><span class="p">,</span> <span class="s1">'bymonthday'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYYEARDAY'</span><span class="p">,</span> <span class="s1">'byyearday'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYWEEKNO'</span><span class="p">,</span> <span class="s1">'byweekno'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYDAY'</span><span class="p">,</span> <span class="s1">'byweekday'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYHOUR'</span><span class="p">,</span> <span class="s1">'byhour'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYMINUTE'</span><span class="p">,</span> <span class="s1">'byminute'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYSECOND'</span><span class="p">,</span> <span class="s1">'bysecond'</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">'BYEASTER'</span><span class="p">,</span> <span class="s1">'byeaster'</span><span class="p">)]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">original_rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="p">(</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                                             <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))))</span>

        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'RRULE:'</span> <span class="o">+</span> <span class="s1">';'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<div class="viewcode-block" id="rrule.replace"><a class="viewcode-back" href="../../api/dates_api.html#matplotlib.dates.rrule.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""Return new rrule with same attributes except for those attributes given new</span>
<span class="sd">           values by whichever keyword arguments are specified."""</span>
        <span class="n">new_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"interval"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">,</span>
                      <span class="s2">"count"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span><span class="p">,</span>
                      <span class="s2">"dtstart"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">,</span>
                      <span class="s2">"freq"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span><span class="p">,</span>
                      <span class="s2">"until"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span><span class="p">,</span>
                      <span class="s2">"wkst"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span><span class="p">,</span>
                      <span class="s2">"cache"</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span> <span class="p">}</span>
        <span class="n">new_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_rule</span><span class="p">)</span>
        <span class="n">new_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rrule</span><span class="p">(</span><span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">weekday</span><span class="p">,</span> <span class="n">yearday</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>

        <span class="c1"># Some local variables to speed things up a bit</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span>
        <span class="n">wkst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkst</span>
        <span class="n">until</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_until</span>
        <span class="n">bymonth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonth</span>
        <span class="n">byweekno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekno</span>
        <span class="n">byyearday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byyearday</span>
        <span class="n">byweekday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byweekday</span>
        <span class="n">byeaster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byeaster</span>
        <span class="n">bymonthday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bymonthday</span>
        <span class="n">bynmonthday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bynmonthday</span>
        <span class="n">bysetpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysetpos</span>
        <span class="n">byhour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span>
        <span class="n">byminute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span>
        <span class="n">bysecond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span>

        <span class="n">ii</span> <span class="o">=</span> <span class="n">_iterinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

        <span class="n">getdayset</span> <span class="o">=</span> <span class="p">{</span><span class="n">YEARLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ydayset</span><span class="p">,</span>
                     <span class="n">MONTHLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">mdayset</span><span class="p">,</span>
                     <span class="n">WEEKLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">wdayset</span><span class="p">,</span>
                     <span class="n">DAILY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">HOURLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">MINUTELY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">,</span>
                     <span class="n">SECONDLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">ddayset</span><span class="p">}[</span><span class="n">freq</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">HOURLY</span><span class="p">:</span>
            <span class="n">timeset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gettimeset</span> <span class="o">=</span> <span class="p">{</span><span class="n">HOURLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">htimeset</span><span class="p">,</span>
                          <span class="n">MINUTELY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">mtimeset</span><span class="p">,</span>
                          <span class="n">SECONDLY</span><span class="p">:</span> <span class="n">ii</span><span class="o">.</span><span class="n">stimeset</span><span class="p">}[</span><span class="n">freq</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">HOURLY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span> <span class="ow">and</span> <span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">MINUTELY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span> <span class="ow">and</span> <span class="n">minute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">SECONDLY</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span> <span class="ow">and</span> <span class="n">second</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">)):</span>
                <span class="n">timeset</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Get dayset with the right frequency</span>
            <span class="n">dayset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">getdayset</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

            <span class="c1"># Do the "hard" work ;-)</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">bymonth</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">mmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bymonth</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byweekno</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byweekday</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byweekday</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">nwdaymask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">nwdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byeaster</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ii</span><span class="o">.</span><span class="n">eastermask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">bymonthday</span> <span class="ow">or</span> <span class="n">bynmonthday</span><span class="p">)</span> <span class="ow">and</span>
                     <span class="n">ii</span><span class="o">.</span><span class="n">mdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bymonthday</span> <span class="ow">and</span>
                     <span class="n">ii</span><span class="o">.</span><span class="n">nmdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bynmonthday</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">byyearday</span> <span class="ow">and</span>
                     <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span> <span class="ow">and</span>
                       <span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span><span class="p">)</span> <span class="ow">or</span>
                      <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">and</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span> <span class="ow">and</span>
                       <span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">nextyearlen</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="n">ii</span><span class="o">.</span><span class="n">yearlen</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byyearday</span><span class="p">)))):</span>
                    <span class="n">dayset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">filtered</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Output results</span>
            <span class="k">if</span> <span class="n">bysetpos</span> <span class="ow">and</span> <span class="n">timeset</span><span class="p">:</span>
                <span class="n">poslist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">bysetpos</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">daypos</span><span class="p">,</span> <span class="n">timepos</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeset</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">daypos</span><span class="p">,</span> <span class="n">timepos</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeset</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                             <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="n">daypos</span><span class="p">]</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">timeset</span><span class="p">[</span><span class="n">timepos</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">yearordinal</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">poslist</span><span class="p">:</span>
                            <span class="n">poslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">poslist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">poslist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">until</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                        <span class="k">return</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
                        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">yield</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dayset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ii</span><span class="o">.</span><span class="n">yearordinal</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">timeset</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">until</span> <span class="ow">and</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="n">until</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
                            <span class="k">elif</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtstart</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                        <span class="k">return</span>

                                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">yield</span> <span class="n">res</span>

            <span class="c1"># Handle frequency and interval</span>
            <span class="n">fixday</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                    <span class="k">return</span>
                <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="n">year</span> <span class="o">+=</span> <span class="n">div</span>
                    <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">month</span> <span class="o">=</span> <span class="mi">12</span>
                        <span class="n">year</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                        <span class="k">return</span>
                <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">WEEKLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wkst</span> <span class="o">&gt;</span> <span class="n">weekday</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">weekday</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="n">wkst</span><span class="p">))</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="o">*</span><span class="mi">7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="o">-</span><span class="p">(</span><span class="n">weekday</span><span class="o">-</span><span class="n">wkst</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="o">*</span><span class="mi">7</span>
                <span class="n">weekday</span> <span class="o">=</span> <span class="n">wkst</span>
                <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">DAILY</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">+=</span> <span class="n">interval</span>
                <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">HOURLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">hour</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">23</span><span class="o">-</span><span class="n">hour</span><span class="p">)</span><span class="o">//</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">interval</span>

                <span class="k">if</span> <span class="n">byhour</span><span class="p">:</span>
                    <span class="n">ndays</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span>
                                                      <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_byhour</span><span class="p">,</span>
                                                      <span class="n">base</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ndays</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ndays</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">+=</span> <span class="n">ndays</span>
                    <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">MINUTELY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">minute</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">1439</span><span class="o">-</span><span class="p">(</span><span class="n">hour</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">minute</span><span class="p">))</span><span class="o">//</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">interval</span>

                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">rep_rate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rep_rate</span> <span class="o">//</span> <span class="n">gcd</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">rep_rate</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">byminute</span><span class="p">:</span>
                        <span class="n">nhours</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">minute</span><span class="p">,</span>
                                                <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_byminute</span><span class="p">,</span>
                                                <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nhours</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minute</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

                    <span class="n">div</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="o">+</span><span class="n">nhours</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                        <span class="n">day</span> <span class="o">+=</span> <span class="n">div</span>
                        <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">filtered</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">byhour</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">byhour</span><span class="p">:</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid combination of interval and '</span> <span class="o">+</span>
                                     <span class="s1">'byhour resulting in empty rule.'</span><span class="p">)</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="n">SECONDLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
                    <span class="c1"># Jump to one iteration before next day</span>
                    <span class="n">second</span> <span class="o">+=</span> <span class="p">(((</span><span class="mi">86399</span> <span class="o">-</span> <span class="p">(</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">second</span><span class="p">))</span>
                                <span class="o">//</span> <span class="n">interval</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span><span class="p">)</span>

                <span class="n">rep_rate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rep_rate</span> <span class="o">//</span> <span class="n">gcd</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">rep_rate</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">bysecond</span><span class="p">:</span>
                        <span class="n">nminutes</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">__mod_distance</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">second</span><span class="p">,</span>
                                                <span class="n">byxxx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">,</span>
                                                <span class="n">base</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nminutes</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">second</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

                    <span class="n">div</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">minute</span><span class="o">+</span><span class="n">nminutes</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                        <span class="n">hour</span> <span class="o">+=</span> <span class="n">div</span>
                        <span class="n">div</span><span class="p">,</span> <span class="n">hour</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">div</span><span class="p">:</span>
                            <span class="n">day</span> <span class="o">+=</span> <span class="n">div</span>
                            <span class="n">fixday</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">byhour</span> <span class="ow">or</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">byhour</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="ow">not</span> <span class="n">byminute</span> <span class="ow">or</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">byminute</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="ow">not</span> <span class="n">bysecond</span> <span class="ow">or</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">bysecond</span><span class="p">)):</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid combination of interval, '</span> <span class="o">+</span>
                                     <span class="s1">'byhour and byminute resulting in empty'</span> <span class="o">+</span>
                                     <span class="s1">' rule.'</span><span class="p">)</span>

                <span class="n">timeset</span> <span class="o">=</span> <span class="n">gettimeset</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fixday</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">:</span>
                <span class="n">daysinmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="n">daysinmonth</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">day</span> <span class="o">&gt;</span> <span class="n">daysinmonth</span><span class="p">:</span>
                        <span class="n">day</span> <span class="o">-=</span> <span class="n">daysinmonth</span>
                        <span class="n">month</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                            <span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">MAXYEAR</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>
                                <span class="k">return</span>
                        <span class="n">daysinmonth</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ii</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__construct_byset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">byxxx</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        If a `BYXXX` sequence is passed to the constructor at the same level as</span>
<span class="sd">        `FREQ` (e.g. `FREQ=HOURLY,BYHOUR={2,4,7},INTERVAL=3`), there are some</span>
<span class="sd">        specifications which cannot be reached given some starting conditions.</span>

<span class="sd">        This occurs whenever the interval is not coprime with the base of a</span>
<span class="sd">        given unit and the difference between the starting position and the</span>
<span class="sd">        ending position is not coprime with the greatest common denominator</span>
<span class="sd">        between the interval and the base. For example, with a FREQ of hourly</span>
<span class="sd">        starting at 17:00 and an interval of 4, the only valid values for</span>
<span class="sd">        BYHOUR would be {21, 1, 5, 9, 13, 17}, because 4 and 24 are not</span>
<span class="sd">        coprime.</span>

<span class="sd">        :param start:</span>
<span class="sd">            Specifies the starting position.</span>
<span class="sd">        :param byxxx:</span>
<span class="sd">            An iterable containing the list of allowed values.</span>
<span class="sd">        :param base:</span>
<span class="sd">            The largest allowable value for the specified frequency (e.g.</span>
<span class="sd">            24 hours, 60 minutes).</span>

<span class="sd">        This does not preserve the type of the iterable, returning a set, since</span>
<span class="sd">        the values should be unique and the order is irrelevant, this will</span>
<span class="sd">        speed up later lookups.</span>

<span class="sd">        In the event of an empty set, raises a :exception:`ValueError`, as this</span>
<span class="sd">        results in an empty rrule.</span>
<span class="sd">        """</span>

        <span class="n">cset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Support a single byxxx value.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">byxxx</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="n">byxxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">byxxx</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">byxxx</span><span class="p">:</span>
            <span class="n">i_gcd</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="c1"># Use divmod rather than % because we need to wrap negative nums.</span>
            <span class="k">if</span> <span class="n">i_gcd</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">i_gcd</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid rrule byxxx generates an empty set."</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cset</span>

    <span class="k">def</span> <span class="nf">__mod_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">byxxx</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Calculates the next value in a sequence where the `FREQ` parameter is</span>
<span class="sd">        specified along with a `BYXXX` parameter at the same "level"</span>
<span class="sd">        (e.g. `HOURLY` specified with `BYHOUR`).</span>

<span class="sd">        :param value:</span>
<span class="sd">            The old value of the component.</span>
<span class="sd">        :param byxxx:</span>
<span class="sd">            The `BYXXX` set, which should have been generated by</span>
<span class="sd">            `rrule._construct_byset`, or something else which checks that a</span>
<span class="sd">            valid rule is present.</span>
<span class="sd">        :param base:</span>
<span class="sd">            The largest allowable value for the specified frequency (e.g.</span>
<span class="sd">            24 hours, 60 minutes).</span>

<span class="sd">        If a valid value is not found after `base` iterations (the maximum</span>
<span class="sd">        number before the sequence would start to repeat), this raises a</span>
<span class="sd">        :exception:`ValueError`, as no valid values were found.</span>

<span class="sd">        This returns a tuple of `divmod(n*interval, base)`, where `n` is the</span>
<span class="sd">        smallest number of `interval` repetitions until the next specified</span>
<span class="sd">        value in `byxxx` is found.</span>
<span class="sd">        """</span>
        <span class="n">accumulator</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Using divmod() over % to account for negative intervals</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">div</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">byxxx</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">accumulator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_iterinfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"rrule"</span><span class="p">,</span> <span class="s2">"lastyear"</span><span class="p">,</span> <span class="s2">"lastmonth"</span><span class="p">,</span>
                 <span class="s2">"yearlen"</span><span class="p">,</span> <span class="s2">"nextyearlen"</span><span class="p">,</span> <span class="s2">"yearordinal"</span><span class="p">,</span> <span class="s2">"yearweekday"</span><span class="p">,</span>
                 <span class="s2">"mmask"</span><span class="p">,</span> <span class="s2">"mrange"</span><span class="p">,</span> <span class="s2">"mdaymask"</span><span class="p">,</span> <span class="s2">"nmdaymask"</span><span class="p">,</span>
                 <span class="s2">"wdaymask"</span><span class="p">,</span> <span class="s2">"wnomask"</span><span class="p">,</span> <span class="s2">"nwdaymask"</span><span class="p">,</span> <span class="s2">"eastermask"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrule</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span> <span class="o">=</span> <span class="n">rrule</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
        <span class="c1"># Every mask is 7 days longer to handle cross-year weekly periods.</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">+</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextyearlen</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">+</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">firstyday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span> <span class="o">=</span> <span class="n">firstyday</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span> <span class="o">=</span> <span class="n">firstyday</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

            <span class="n">wday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span> <span class="o">==</span> <span class="mi">365</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mmask</span> <span class="o">=</span> <span class="n">M365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mdaymask</span> <span class="o">=</span> <span class="n">MDAY365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmdaymask</span> <span class="o">=</span> <span class="n">NMDAY365MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span> <span class="o">=</span> <span class="n">WDAYMASK</span><span class="p">[</span><span class="n">wday</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span> <span class="o">=</span> <span class="n">M365RANGE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mmask</span> <span class="o">=</span> <span class="n">M366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mdaymask</span> <span class="o">=</span> <span class="n">MDAY366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nmdaymask</span> <span class="o">=</span> <span class="n">NMDAY366MASK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span> <span class="o">=</span> <span class="n">WDAYMASK</span><span class="p">[</span><span class="n">wday</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span> <span class="o">=</span> <span class="n">M366RANGE</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
                <span class="c1"># no1wkst = firstwkst = self.wdaymask.index(rr._wkst)</span>
                <span class="n">no1wkst</span> <span class="o">=</span> <span class="n">firstwkst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span><span class="o">+</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">no1wkst</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># Number of days in the year, plus the days we got</span>
                    <span class="c1"># from last year.</span>
                    <span class="n">wyearlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearweekday</span><span class="o">-</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Number of days in the year, minus the days we</span>
                    <span class="c1"># left in last year.</span>
                    <span class="n">wyearlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">-</span><span class="n">no1wkst</span>
                <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">wyearlen</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">numweeks</span> <span class="o">=</span> <span class="n">div</span><span class="o">+</span><span class="n">mod</span><span class="o">//</span><span class="mi">4</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="n">numweeks</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">numweeks</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                        <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">!=</span> <span class="n">firstwkst</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">-=</span> <span class="mi">7</span><span class="o">-</span><span class="n">firstwkst</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                    <span class="c1"># Check week number 1 of next year as well</span>
                    <span class="c1"># TODO: Check -numweeks for next year.</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">no1wkst</span><span class="o">+</span><span class="n">numweeks</span><span class="o">*</span><span class="mi">7</span>
                    <span class="k">if</span> <span class="n">no1wkst</span> <span class="o">!=</span> <span class="n">firstwkst</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">7</span><span class="o">-</span><span class="n">firstwkst</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">:</span>
                        <span class="c1"># If week starts in next year, we</span>
                        <span class="c1"># don't care about it.</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">no1wkst</span><span class="p">:</span>
                    <span class="c1"># Check last week number of last year as</span>
                    <span class="c1"># well. If no1wkst is 0, either the year</span>
                    <span class="c1"># started on week start, or week number 1</span>
                    <span class="c1"># got days from last year, so there are no</span>
                    <span class="c1"># days from last year's last week number in</span>
                    <span class="c1"># this year.</span>
                    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                        <span class="n">lyearweekday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
                        <span class="n">lno1wkst</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">lyearweekday</span><span class="o">+</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="n">lyearlen</span> <span class="o">=</span> <span class="mi">365</span><span class="o">+</span><span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lno1wkst</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">lno1wkst</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">lnumweeks</span> <span class="o">=</span> <span class="mi">52</span><span class="o">+</span><span class="p">(</span><span class="n">lyearlen</span> <span class="o">+</span>
                                            <span class="p">(</span><span class="n">lyearweekday</span><span class="o">-</span><span class="n">rr</span><span class="o">.</span><span class="n">_wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="o">//</span><span class="mi">4</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lnumweeks</span> <span class="o">=</span> <span class="mi">52</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">-</span><span class="n">no1wkst</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="o">//</span><span class="mi">4</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lnumweeks</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">lnumweeks</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byweekno</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no1wkst</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">wnomask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">_bynweekday</span> <span class="ow">and</span> <span class="p">(</span><span class="n">month</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastmonth</span> <span class="ow">or</span>
                                <span class="n">year</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span><span class="p">)):</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_freq</span> <span class="o">==</span> <span class="n">YEARLY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bymonth</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bymonth</span><span class="p">:</span>
                        <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">rr</span><span class="o">.</span><span class="n">_freq</span> <span class="o">==</span> <span class="n">MONTHLY</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">ranges</span><span class="p">:</span>
                <span class="c1"># Weekly frequency won't get here, so we may not</span>
                <span class="c1"># care about cross-year weekly periods.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nwdaymask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
                <span class="k">for</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">wday</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bynweekday</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">last</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                            <span class="n">i</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">wday</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">first</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">wday</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
                        <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">nwdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byeaster</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eastermask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">eyday</span> <span class="o">=</span> <span class="n">easter</span><span class="o">.</span><span class="n">easter</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
            <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byeaster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eastermask</span><span class="p">[</span><span class="n">eyday</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastyear</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastmonth</span> <span class="o">=</span> <span class="n">month</span>

    <span class="k">def</span> <span class="nf">ydayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>

    <span class="k">def</span> <span class="nf">mdayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mrange</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">wdayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="c1"># We need to handle cross-year weeks here.</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># if (not (0 &lt;= i &lt; self.yearlen) or</span>
            <span class="c1">#    self.wdaymask[i] == self.rrule._wkst):</span>
            <span class="c1"># This will cross the year boundary, if necessary.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdaymask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">_wkst</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">ddayset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearlen</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearordinal</span>
        <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">dset</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">htimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="n">tset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">for</span> <span class="n">minute</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_byminute</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
                <span class="n">tset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                                          <span class="n">tzinfo</span><span class="o">=</span><span class="n">rr</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
        <span class="n">tset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tset</span>

    <span class="k">def</span> <span class="nf">mtimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="n">tset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrule</span>
        <span class="k">for</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">_bysecond</span><span class="p">:</span>
            <span class="n">tset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">rr</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">))</span>
        <span class="n">tset</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tset</span>

    <span class="k">def</span> <span class="nf">stimeset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
                <span class="n">tzinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rrule</span><span class="o">.</span><span class="n">_tzinfo</span><span class="p">),)</span>


<span class="k">class</span> <span class="nc">rruleset</span><span class="p">(</span><span class="n">rrulebase</span><span class="p">):</span>
    <span class="sd">""" The rruleset type allows more complex recurrence setups, mixing</span>
<span class="sd">    multiple rules, dates, exclusion rules, and exclusion dates. The type</span>
<span class="sd">    constructor takes the following keyword arguments:</span>

<span class="sd">    :param cache: If True, caching of results will be enabled, improving</span>
<span class="sd">                  performance of multiple queries considerably. """</span>

    <span class="k">class</span> <span class="nc">_genitem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
                <span class="n">genlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span> <span class="o">=</span> <span class="n">genlist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span>

        <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">advance_iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genlist</span><span class="p">)</span>

        <span class="nb">next</span> <span class="o">=</span> <span class="fm">__next__</span>

        <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

        <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">dt</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">rruleset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">rrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrule</span><span class="p">):</span>
        <span class="sd">""" Include the given :py:class:`rrule` instance in the recurrence set</span>
<span class="sd">            generation. """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrule</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">rdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdate</span><span class="p">):</span>
        <span class="sd">""" Include the given :py:class:`datetime` instance in the recurrence</span>
<span class="sd">            set generation. """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdate</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">exrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exrule</span><span class="p">):</span>
        <span class="sd">""" Include the given rrule instance in the recurrence set exclusion</span>
<span class="sd">            list. Dates which are part of the given recurrence rules will not</span>
<span class="sd">            be generated, even if some inclusive rrule or rdate matches them.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exrule</span><span class="p">)</span>

    <span class="nd">@_invalidates_cache</span>
    <span class="k">def</span> <span class="nf">exdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exdate</span><span class="p">):</span>
        <span class="sd">""" Include the given datetime instance in the recurrence set</span>
<span class="sd">            exclusion list. Dates included that way will not be generated,</span>
<span class="sd">            even if some inclusive rrule or rdate matches them. """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exdate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rdate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrule</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">exlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exdate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exrule</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genitem</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">lastdt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">rlist</span><span class="p">)</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">exlist</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rlist</span><span class="p">:</span>
            <span class="n">ritem</span> <span class="o">=</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lastdt</span> <span class="ow">or</span> <span class="n">lastdt</span> <span class="o">!=</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">exlist</span> <span class="ow">and</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ritem</span><span class="p">:</span>
                    <span class="n">exitem</span> <span class="o">=</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">advance_iterator</span><span class="p">(</span><span class="n">exitem</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exlist</span> <span class="ow">and</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">exitem</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heapreplace</span><span class="p">(</span><span class="n">exlist</span><span class="p">,</span> <span class="n">exitem</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exlist</span> <span class="ow">or</span> <span class="n">ritem</span> <span class="o">!=</span> <span class="n">exlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span>
                <span class="n">lastdt</span> <span class="o">=</span> <span class="n">ritem</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">advance_iterator</span><span class="p">(</span><span class="n">ritem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rlist</span> <span class="ow">and</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ritem</span><span class="p">:</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heapreplace</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">ritem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">total</span>


<span class="k">class</span> <span class="nc">_rrulestr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_freq_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"YEARLY"</span><span class="p">:</span> <span class="n">YEARLY</span><span class="p">,</span>
                 <span class="s2">"MONTHLY"</span><span class="p">:</span> <span class="n">MONTHLY</span><span class="p">,</span>
                 <span class="s2">"WEEKLY"</span><span class="p">:</span> <span class="n">WEEKLY</span><span class="p">,</span>
                 <span class="s2">"DAILY"</span><span class="p">:</span> <span class="n">DAILY</span><span class="p">,</span>
                 <span class="s2">"HOURLY"</span><span class="p">:</span> <span class="n">HOURLY</span><span class="p">,</span>
                 <span class="s2">"MINUTELY"</span><span class="p">:</span> <span class="n">MINUTELY</span><span class="p">,</span>
                 <span class="s2">"SECONDLY"</span><span class="p">:</span> <span class="n">SECONDLY</span><span class="p">}</span>

    <span class="n">_weekday_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"MO"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"TU"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"WE"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"TH"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s2">"FR"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"SA"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"SU"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_handle_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_int_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)]</span>

    <span class="n">_handle_INTERVAL</span> <span class="o">=</span> <span class="n">_handle_int</span>
    <span class="n">_handle_COUNT</span> <span class="o">=</span> <span class="n">_handle_int</span>
    <span class="n">_handle_BYSETPOS</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMONTH</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMONTHDAY</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYYEARDAY</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYEASTER</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYWEEKNO</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYHOUR</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYMINUTE</span> <span class="o">=</span> <span class="n">_handle_int_list</span>
    <span class="n">_handle_BYSECOND</span> <span class="o">=</span> <span class="n">_handle_int_list</span>

    <span class="k">def</span> <span class="nf">_handle_FREQ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">"freq"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_handle_UNTIL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">"until"</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                                             <span class="n">ignoretz</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ignoretz"</span><span class="p">),</span>
                                             <span class="n">tzinfos</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tzinfos"</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"invalid until date"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_WKST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">"wkst"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weekday_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_handle_BYWEEKDAY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Two ways to specify this: +1MO or MO(+1)</span>
<span class="sd">        """</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wday</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">'('</span> <span class="ow">in</span> <span class="n">wday</span><span class="p">:</span>
                <span class="c1"># If it's of the form TH(+1), etc.</span>
                <span class="n">splt</span> <span class="o">=</span> <span class="n">wday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'('</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">splt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">wday</span><span class="p">):</span>
                <span class="c1"># If it's of the form +1MO</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wday</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">wday</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">'+-0123456789'</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">wday</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">wday</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid (empty) BYDAY specification."</span><span class="p">)</span>

            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weekdays</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekday_map</span><span class="p">[</span><span class="n">w</span><span class="p">]](</span><span class="n">n</span><span class="p">))</span>
        <span class="n">rrkwargs</span><span class="p">[</span><span class="s2">"byweekday"</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

    <span class="n">_handle_BYDAY</span> <span class="o">=</span> <span class="n">_handle_BYWEEKDAY</span>

    <span class="k">def</span> <span class="nf">_parse_rfc_rrule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
                         <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">ignoretz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">tzinfos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">"RRULE"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unknown parameter name"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">rrkwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_handle_"</span><span class="o">+</span><span class="n">name</span><span class="p">)(</span><span class="n">rrkwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                               <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                               <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unknown parameter '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"invalid '</span><span class="si">%s</span><span class="s2">': </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rrule</span><span class="p">(</span><span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="o">**</span><span class="n">rrkwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_rfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                   <span class="n">dtstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">unfold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">forceset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">ignoretz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">tzids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">tzinfos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="n">compatible</span><span class="p">:</span>
            <span class="n">forceset</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">unfold</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">TZID_NAMES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">x</span><span class="p">),</span>
            <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">'TZID=(?P&lt;name&gt;[^:]+):'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"empty string"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unfold</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">" "</span><span class="p">:</span>
                    <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">forceset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                                                  <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'RRULE:'</span><span class="p">))):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                         <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span> <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                         <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rrulevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rdatevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">exrulevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">exdatevals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">"RRULE"</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parms</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"empty property name"</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"RRULE"</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported RRULE parm: "</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">rrulevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"RDATE"</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parm</span> <span class="o">!=</span> <span class="s2">"VALUE=DATE-TIME"</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported RDATE parm: "</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">rdatevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"EXRULE"</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported EXRULE parm: "</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">exrulevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"EXDATE"</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parm</span> <span class="o">!=</span> <span class="s2">"VALUE=DATE-TIME"</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported EXDATE parm: "</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                    <span class="n">exdatevals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"DTSTART"</span><span class="p">:</span>
                    <span class="c1"># RFC 5445 3.8.2.4: The VALUE parameter is optional, but</span>
                    <span class="c1"># may be found only once.</span>
                    <span class="n">value_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">TZID</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">valid_values</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"VALUE=DATE-TIME"</span><span class="p">,</span> <span class="s2">"VALUE=DATE"</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"TZID="</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tzkey</span> <span class="o">=</span> <span class="n">TZID_NAMES</span><span class="p">[</span><span class="n">parm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'TZID='</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">tzids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tz</span>
                                <span class="n">tzlookup</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">gettz</span>
                            <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">tzids</span><span class="p">):</span>
                                <span class="n">tzlookup</span> <span class="o">=</span> <span class="n">tzids</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tzlookup</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tzids</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">tzlookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'tzids must be a callable, '</span> <span class="o">+</span>
                                           <span class="s1">'mapping, or None, '</span> <span class="o">+</span>
                                           <span class="s1">'not </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">tzids</span><span class="p">)</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                            <span class="n">TZID</span> <span class="o">=</span> <span class="n">tzlookup</span><span class="p">(</span><span class="n">tzkey</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">parm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_values</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported DTSTART parm: "</span><span class="o">+</span><span class="n">parm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">value_found</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"Duplicate value parameter found in "</span> <span class="o">+</span>
                                       <span class="s2">"DTSTART: "</span> <span class="o">+</span> <span class="n">parm</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">value_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
                    <span class="n">dtstart</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                           <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">TZID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">dtstart</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">TZID</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'DTSTART specifies multiple timezones'</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unsupported property: "</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">forceset</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rrulevals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">rdatevals</span>
                    <span class="ow">or</span> <span class="n">exrulevals</span> <span class="ow">or</span> <span class="n">exdatevals</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rdatevals</span> <span class="ow">or</span> <span class="n">exdatevals</span><span class="p">):</span>
                    <span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
                <span class="n">rset</span> <span class="o">=</span> <span class="n">rruleset</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rrulevals</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">rrule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                                     <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                     <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rdatevals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">):</span>
                        <span class="n">rset</span><span class="o">.</span><span class="n">rdate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span>
                                                <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exrulevals</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">exrule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                                      <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                      <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">exdatevals</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">):</span>
                        <span class="n">rset</span><span class="o">.</span><span class="n">exdate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span>
                                                 <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                                 <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">compatible</span> <span class="ow">and</span> <span class="n">dtstart</span><span class="p">:</span>
                    <span class="n">rset</span><span class="o">.</span><span class="n">rdate</span><span class="p">(</span><span class="n">dtstart</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc_rrule</span><span class="p">(</span><span class="n">rrulevals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">dtstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>
                                             <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
                                             <span class="n">ignoretz</span><span class="o">=</span><span class="n">ignoretz</span><span class="p">,</span>
                                             <span class="n">tzinfos</span><span class="o">=</span><span class="n">tzinfos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_rfc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">rrulestr</span> <span class="o">=</span> <span class="n">_rrulestr</span><span class="p">()</span>

<span class="c1"># vim:ts=4:sw=4:et</span>
</pre></div>
</div>
</div>
</div>
<div class="clearer"></div>
</div>
<div class="footer">
        © Copyright 2002 - 2012 John Hunter, Darren Dale, Eric Firing, Michael Droettboom and the Matplotlib development team; 2012 - 2018 The Matplotlib development team.
        <br/>
      Last updated on Jun 28, 2018.
	Created using
	<ahref>Sphinx 1.7.5.
	Doc version v2.2.2-101-g15e1eadd0.
    </ahref></div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55954603-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
<footer>
<!--Flipcause Integration v3.0// Flipcause Integration Instructions:
Install the following code block once in the website Header (after <head> tag) -->
<style>

.fc-black_overlay{
display:none; position: fixed; z-index:1000001; top: 0%;left: 0%;width: 100%;height: 100%;
background-color: black; filter: alpha(opacity=50); cursor:pointer; opacity:0.5;
}

.fc-white_content {
opacity:1; display:none; margin-top: -320px; margin-left: -485px; width:970px; height:640px;
position:fixed; top:50%; left:50%; border: none;z-index:1000002;overflow: auto;
}

.fc-main-box{
opacity:1; display:none; margin:15px auto 0 auto; width:930px; position:relative; z-index:1000003;
}

.fc-widget_close{
opacity:1; content:url(http://i1338.photobucket.com/albums/o691/WeCause/X_zpse4a7e538.png);
position:absolute; z-index=1000004; right:-16px; top:-16px; display:block; cursor:pointer;
}

.floating_button{
display: block; margin-top: 0px; margin-left: 0px; width:auto ; height: auto;
position:fixed; z-index:999999; overflow: auto;
}

@keyframes backfadesin {
   from { opacity:0; }
   to {opacity:.5;}
}

@-moz-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@-webkit-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@-o-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}


@-ms-keyframes backfadesin {
    from { opacity:0; }
    to {opacity:.5;}
}

@keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; transform: translateY(20px);}
   100% {opacity: 1; transform: translateY(0);}
}

@-moz-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -moz-transform: translateY(20px);}
   100% {opacity: 1; -moz-transform: translateY(0);}
}

@-webkit-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -webkit-transform: translateY(20px);}
   100% {opacity: 1; -webkit-transform: translateY(0);}
}

@-o-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -o-transform: translateY(20px);}
   100% {opacity: 1; -o-transform: translateY(0);}
}

@-ms-keyframes fadesin {
   0%{ opacity:0; }
   50%{ opacity:0; }
   75% {opacity: 0; -ms-transform: translateY(20px);}
   100% {opacity: 1; -ms-transform: translateY(0);}
}

</style>
<div class="fc-black_overlay" id="fc-fade" onclick="close_window()"></div>
<div class="fc-white_content" id="fc-light">
<div class="fc-main-box" id="fc-main">
<div class="fc-widget_close" id="fc-close" onclick="close_window()">
</div><iframe height="580" id="fc-myFrame" iframe="" scrolling="no" src="" style="border: 0;
border-radius:5px 5px 5px 5px; box-shadow:0 0 8px rgba(0, 0, 0, 0.5);" width="925"></iframe></div>
</div>
<!--END Flipcause Main Integration Code-->
</footer>
</html>